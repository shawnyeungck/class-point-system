<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>真道非華語課堂加分系統 (Web版)</title>
  
  <!-- 外部套件 (Bootstrap, Fonts, Icons) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Baloo+2:wght@600;700;800&family=Noto+Serif+TC:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- 連結你的 CSS 檔案 -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Loading 動畫 -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner-border text-light mb-3" role="status"></div>
  <h3>資料載入中...</h3>
  <div class="progress w-50 mt-3" style="height: 10px;">
    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
  </div>
</div>

<!-- 圖片放大 Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body text-center">
        <img id="expandedImage" src="" class="img-fluid rounded shadow-lg">
      </div>
    </div>
  </div>
</div>

<!-- 控制面板 (頂部) -->
<div class="control-panel">
  <div class="teacher-info">
    <i class="fas fa-chalkboard-teacher me-2"></i><span id="displayTeacherName"></span>
  </div>
  <div class="control-buttons">
    <button class="modern-btn" onclick="switchCategory('luckydraw')" style="background:linear-gradient(135deg,#FF9A9E,#FECFEF);color:#555">
      <i class="fas fa-dice"></i> 抽籤
    </button>
    <button class="modern-btn" onclick="switchCategory('dice')" style="background:linear-gradient(135deg,#a18cd1,#fbc2eb);color:white">
      <i class="fas fa-dice-d20"></i> 骰子
    </button>
    <button class="modern-btn" onclick="switchCategory('bible')" style="background:linear-gradient(135deg,#84fab0,#8fd3f4);color:#444">
      <i class="fas fa-book-open"></i> 金句
    </button>
    <button class="modern-btn btn-timer" onclick="toggleTimerPanel()" style="background:linear-gradient(135deg,#A8E6CF,#3498db);color:white">
      <i class="fas fa-stopwatch"></i> 計時
    </button>
    <button class="modern-btn btn-sort" id="sortScoresButton" onclick="toggleSort()">
      <i class="fas fa-sort-amount-down"></i> 排序
    </button>
    <button class="modern-btn btn-update" id="updateScoresButton" onclick="updateScores()">
      <i class="fas fa-sync-alt"></i> 更新
    </button>
    <button class="modern-btn btn-login" id="loginButton" onclick="showLoginOverlay()">
      <i class="fas fa-sign-in-alt"></i> 登入
    </button>
    <button class="modern-btn btn-logout" id="logoutButton" onclick="logoutTeacher()">
      <i class="fas fa-sign-out-alt"></i> 登出
    </button>
  </div>
</div>

<!-- 跑馬燈 -->
<div id="marqueeContainer" class="marquee-container" style="display:none">
  <div class="text-danger me-3"><i class="fas fa-bullhorn"></i></div>
  <div class="marquee-wrapper">
    <div id="marqueeContent" class="marquee-content"></div>
  </div>
</div>

<!-- 登入視窗 Overlay -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-overlay-content">
    <h4 class="text-center fw-bold mb-4">教師登入</h4>
    <input type="text" id="loginAccount" class="form-control mb-3" placeholder="帳號">
    <input type="password" id="loginPassword" class="form-control mb-3" placeholder="密碼">
    <button class="modern-btn btn-login w-100 mb-2" onclick="loginTeacher()">登入</button>
    <button class="modern-btn w-100" style="background:#eee" onclick="hideLoginOverlay()">取消</button>
  </div>
</div>

<!-- 分頁導航 Tabs -->
<ul class="nav nav-tabs" id="categoryTabs">
  <li class="nav-item">
    <button class="nav-link glass-tab active" data-type="student" onclick="switchCategory('student')">
      <i class="fas fa-user-graduate me-2"></i>學生
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" data-type="group" onclick="switchCategory('group')">
      <i class="fas fa-users me-2"></i>小組
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" data-type="gift" onclick="switchCategory('gift')">
      <i class="fas fa-gift me-2"></i>禮物
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" data-type="title" onclick="switchCategory('title')">
      <i class="fas fa-crown me-2"></i>稱號
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" data-type="log" onclick="switchCategory('log')">
      <i class="fas fa-scroll me-2"></i>得分紀錄表
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" onclick="openELearning()" style="color:#0d6efd">
      <i class="fas fa-laptop-code me-2"></i>電子溫習站
    </button>
  </li>
</ul>

<!-- 篩選按鈕區 -->
<div id="filterContainer"></div>

<!-- ================= 內容區塊 ================= -->

<!-- 學生頁面 -->
<div id="studentContainer">
  <div class="grid-container" id="studentSection"></div>
</div>

<!-- 小組頁面 -->
<div id="groupContainer" style="display:none">
  <div class="grid-container" id="groupSection"></div>
</div>

<!-- 禮物頁面 -->
<div id="giftContainer" style="display:none">
  <div id="giftSection"></div>
</div>

<!-- 稱號頁面 -->
<div id="titleContainer" style="display:none">
  <div class="grid-container" id="titleSection"></div>
  <div class="title-footer-text mt-4">努力累積積分，獲得更酷的稱號吧！</div>
</div>

<!-- 紀錄頁面 -->
<div id="logContainer" style="display:none">
  <div class="filter-wrapper">
    <select class="form-select d-inline-block w-auto me-2" id="logGroupSelect" onchange="onLogGroupChange()">
      <option value="all">全部組別</option>
    </select>
    <select class="form-select d-inline-block w-auto" id="logFilterSelect" onchange="filterLogs()">
      <option value="all">全部學生</option>
    </select>
  </div>
  <div class="table-responsive mt-3">
    <table class="log-table">
      <thead>
        <tr>
          <th>時間</th>
          <th>學生</th>
          <th>老師</th>
          <th>項目</th>
          <th>得分</th>
        </tr>
      </thead>
      <tbody id="logTableBody"></tbody>
    </table>
  </div>
</div>

<!-- 幸運抽籤頁面 -->
<div id="luckyDrawContainer" style="display:none;max-width:1200px;margin:0 auto">
  <div id="luckyGroupSelector" class="d-flex flex-wrap justify-content-center gap-2 mb-4"></div>
  <div class="row g-4">
    <div class="col-md-7">
      <div class="lucky-stage">
        <div id="luckyCard" class="lucky-card">
          <div class="lucky-img-box">
            <img id="luckyImage" style="display:none">
            <i class="fas fa-question fa-3x text-muted" id="luckyDefaultIcon"></i>
          </div>
          <div class="lucky-name" id="luckyName">誰是幸運兒？</div>
        </div>
        <div class="mt-4">
          <button class="modern-btn me-2" id="startLuckyBtn" onclick="toggleLuckyDrawManual()" style="background:#FF6B6B;color:white">手動開始</button>
          <button class="modern-btn" id="autoLuckyBtn" onclick="startAutoLuckyDraw()" style="background:#4ECDC4;color:white">電腦搞珠</button>
        </div>
      </div>
    </div>
    <div class="col-md-5">
      <div class="exclusion-panel">
        <h5 class="text-center mb-3">
          點擊頭像排除學生 
          <button class="btn btn-sm btn-outline-secondary ms-2" onclick="resetExclusion()">重置</button>
        </h5>
        <div id="exclusionList" class="exclusion-grid"></div>
      </div>
    </div>
  </div>
</div>

<!-- 骰子頁面 -->
<div id="diceContainer" style="display:none;max-width:800px;margin:0 auto">
  <div class="glass-tab p-5 text-center" style="border-radius:30px">
    <h3><i class="fas fa-dice me-2"></i>命運的骰子</h3>
    <div class="d-flex justify-content-center gap-4 my-4">
      <div class="dice-selector active" id="selDice6" onclick="selectDiceType(6)">
        <i class="fas fa-dice-six fa-2x"></i> 6面
      </div>
      <div class="dice-selector" id="selDice20" onclick="selectDiceType(20)">
        <i class="fas fa-dice-d20 fa-2x"></i> 20面
      </div>
    </div>
    <div class="dice-stage mb-4">
      <div id="diceDisplay" class="dice-box dice-d6"><span id="diceResult">?</span></div>
    </div>
    <button class="modern-btn fs-4 px-5 py-2" onclick="rollDice()" style="background:#667eea;color:white">試試手氣</button>
  </div>
</div>

<!-- 金句頁面 -->
<div id="bibleContainer" style="display:none;max-width:1000px;margin:0 auto">
  <div id="currentVerseSection" class="mb-5">
    <div id="currentVerseCard"></div>
  </div>
  <div class="glass-tab p-4" style="border-radius:20px">
    <h4 class="mb-3"><i class="fas fa-history me-2"></i>金句庫</h4>
    <div id="bibleList" class="row g-3"></div>
  </div>
</div>

<!-- ================= Modals 彈出視窗 ================= -->

<!-- 加扣分 Modal -->
<div class="modal fade" id="scoreModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="scoreModalLabel">操作</h5>
        <button type="button" class="btn-close" onclick="closeScoreModal()"></button>
      </div>
      <div class="modal-body">
        <p id="modalTargetInfo" class="fs-5 text-center fw-bold"></p>
        
        <!-- Batch Selector -->
        <div id="groupBatchSelector" style="display:none">
           <div class="d-flex justify-content-between mb-2">
             <small class="fw-bold">點擊頭像排除</small>
             <button class="btn btn-sm btn-outline-primary py-0" onclick="resetBatchSelection()">全選</button>
           </div>
           <div id="batchGrid" class="batch-grid"></div>
        </div>

        <!-- XP Bar -->
        <div id="xpContainer" class="mb-3 p-3 rounded bg-light border" style="display:none">
           <div id="xpText" class="text-center fw-bold mb-2"></div>
           <div class="progress" style="height:10px">
             <div id="xpBar" class="progress-bar bg-warning" style="width:0%"></div>
           </div>
           <div id="monthlyScoreText" class="text-center mt-2 small text-muted"></div>
        </div>

        <!-- History -->
        <div id="historyContainer" class="p-3 rounded bg-white border mb-3" style="display:none">
           <h6 class="text-center text-muted mb-2">最近紀錄</h6>
           <table class="table table-sm mb-0">
             <thead><tr><th>日期</th><th>項目</th><th class="text-end">分</th></tr></thead>
             <tbody id="historyTableBody"></tbody>
           </table>
           <div class="d-flex justify-content-between mt-2">
             <button class="btn btn-sm btn-light" id="prevHistoryBtn" onclick="changeHistoryPage(-1)">◀</button>
             <span id="historyPageLabel">1/1</span>
             <button class="btn btn-sm btn-light" id="nextHistoryBtn" onclick="changeHistoryPage(1)">▶</button>
           </div>
        </div>

        <!-- Teacher Controls -->
        <div id="teacherControls" style="display:none">
            <div class="d-flex gap-2 mb-3">
              <button class="modern-btn flex-fill" style="background:#4ECDC4;color:white" id="addPointsBtn" onclick="setScoreCategory('加分')">加分</button>
              <button class="modern-btn flex-fill" style="background:white;border:1px solid #ddd;color:#aaa" id="deductPointsBtn" onclick="setScoreCategory('扣分')">扣分</button>
            </div>
            <div class="mb-3">
              <select class="form-select" id="itemSelect" onchange="updateScoreOptions()"></select>
            </div>
            <div class="mb-3">
              <select class="form-select" id="scoreSelect" onchange="toggleCustomInput()"></select>
              <input type="number" id="customScoreInput" class="form-control mt-2" placeholder="輸入數值" style="display:none">
            </div>
        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-light" onclick="closeScoreModal()">取消</button>
        <button class="btn btn-primary" id="confirmScoreBtn" onclick="sendScoreRecord()">送出</button>
      </div>
    </div>
  </div>
</div>

<!-- 編輯紀錄 Modal (已包含項目修改) -->
<div class="modal fade" id="editLogModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">✏️ 編輯紀錄</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editLogRowIndex">
        <div class="mb-3">
          <label class="form-label">學生姓名</label>
          <input type="text" class="form-control" id="editLogName">
        </div>
        <div class="mb-3">
          <label class="form-label">項目名稱</label>
          <input type="text" class="form-control" id="editLogItem">
        </div>
        <div class="mb-3">
          <label class="form-label">分數</label>
          <input type="number" class="form-control" id="editLogScore">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="doEditLog()">儲存修改</button>
      </div>
    </div>
  </div>
</div>

<!-- 排名 Modal -->
<div class="modal fade" id="rankingModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center" id="rankingModalBody"></div>
      <div class="modal-footer justify-content-center border-0">
        <button class="btn btn-primary rounded-pill px-4" data-bs-dismiss="modal">讚！</button>
      </div>
    </div>
  </div>
</div>

<!-- 計時器面板 -->
<div id="timerPanel" class="timer-overlay" style="display:none">
  <div class="timer-box">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4><i class="fas fa-clock"></i> 計時器</h4>
      <button class="btn-close" onclick="toggleTimerPanel()"></button>
    </div>
    <div class="timer-display" id="timerDisplay">00:00</div>
    <div class="d-flex justify-content-center gap-2 mb-3">
      <input type="number" id="timerInputMin" class="form-control text-center" placeholder="分" style="width:70px">
      <input type="number" id="timerInputSec" class="form-control text-center" placeholder="秒" style="width:70px">
      <button class="btn btn-dark" onclick="applyCustomTime()">設定</button>
    </div>
    <div class="mb-4 small text-muted">
      <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="addTime(1)">+1分</button> 
      <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="addTime(5)">+5分</button>
    </div>
    <div>
      <button class="btn btn-success me-2" id="btnStartTimer" onclick="startTimer()">開始</button>
      <button class="btn btn-warning me-2" id="btnPauseTimer" onclick="stopTimer()" style="display:none">暫停</button>
      <button class="btn btn-danger" onclick="resetTimer()">重置</button>
    </div>
  </div>
</div>

<!-- 引入 Bootstrap JS (必要) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 連結你的 JS 檔案 (大腦) -->
<script src="script.js"></script>

</body>
</html>