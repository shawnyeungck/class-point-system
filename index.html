<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>çœŸé“éè¯èªèª²å ‚åŠ åˆ†ç³»çµ± (Webç‰ˆ)</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Baloo+2:wght@600;700;800&family=Noto+Serif+TC:wght@600;700&display=swap" rel="stylesheet">
  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Custom Styles -->
  <style>
    /* --- éš¨æ©Ÿéª°å­æ¨£å¼ --- */
    .dice-selector { cursor: pointer; padding: 15px 25px; border-radius: 20px; border: 2px solid transparent; background: rgba(255, 255, 255, 0.4); transition: all 0.3s; color: #555; opacity: 0.7; }
    .dice-selector:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.7); }
    .dice-selector.active { border-color: var(--primary-color); background: white; color: var(--primary-color); opacity: 1; box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3); font-weight: bold; }
    .dice-stage { height: 200px; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
    .dice-box { width: 150px; height: 150px; display: flex; justify-content: center; align-items: center; font-size: 5rem; font-weight: 800; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); transition: transform 0.5s; position: relative; }
    .dice-d6 { background: linear-gradient(135deg, #FF6B6B, #EE5253); border-radius: 25px; box-shadow: 0 10px 25px rgba(238, 82, 83, 0.4); border: 4px solid rgba(255,255,255,0.3); }
    .dice-d20 { width: 160px; height: 185px; background: linear-gradient(135deg, #4ECDC4, #2CB5AC); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); border-radius: 0; filter: drop-shadow(0 10px 15px rgba(44, 181, 172, 0.4)); }
    .dice-d20::before { content: ''; position: absolute; inset: 5px; background: transparent; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); border: 2px solid rgba(255,255,255,0.4); z-index: 1; }
    .dice-box span { z-index: 2; }
    .dice-shaking { animation: shakeDice 0.5s infinite; }
    @keyframes shakeDice { 0% { transform: rotate(0deg) translate(0, 0); } 25% { transform: rotate(15deg) translate(10px, -10px); } 50% { transform: rotate(0deg) translate(0, 20px) scale(0.9); } 75% { transform: rotate(-15deg) translate(-10px, -10px); } 100% { transform: rotate(0deg) translate(0, 0); } }
    .dice-pop { animation: popNum 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popNum { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    :root {
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.5);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      --glass-blur: blur(12px);
      --primary-color: #FF6B6B; --secondary-color: #4ECDC4; --accent-color: #FFE66D; --dark-color: #2D3E50; --text-color: #1a2a3a;
      --tier1-color: #A0E7E5; --tier2-color: #B4F8C8; --tier3-color: #FBE7C6; --tier4-color: #FFAEBC; --tier5-color: #D4A5A5; 
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { padding: 0; margin: 0; font-family: 'Noto Sans TC', sans-serif; min-height: 100vh; color: var(--text-color); background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradientBG 15s ease infinite; overflow-x: hidden; padding-top: 80px; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    h1, h2, h3, h4, h5, h6, .student-name, .group-name, .score-overlay, .cumulative-overlay, .info-pill, .gift-category-label, button { font-family: 'Baloo 2', 'Noto Sans TC', cursive, sans-serif; }

    /* Control Panel */
    .control-panel { position: fixed; top: 10px; left: 10px; right: 10px; z-index: 1000; padding: 10px 20px; border-radius: 25px; display: flex; flex-direction: row; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    .teacher-info { font-size: 1rem; font-weight: 700; display: none; color: var(--dark-color); background: rgba(255,255,255,0.5); padding: 5px 15px; border-radius: 20px; }
    .control-buttons { display: flex; gap: 10px; margin-left: auto; }
    .modern-btn { border: none; border-radius: 15px; padding: 8px 16px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 5px; }
    .modern-btn:active { transform: scale(0.95); }
    .modern-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .btn-sort { background: linear-gradient(135deg, #FFE66D 0%, #FFD23F 100%); color: #5a4b00; }
    .btn-update { background: linear-gradient(135deg, #4ECDC4 0%, #2CB5AC 100%); color: white; }
    .btn-login { background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); color: white; }
    .btn-logout { background: rgba(255,255,255,0.8); color: var(--dark-color); border: 1px solid #ddd; display: none; }

    @media (max-width: 575px) {
      .control-panel { flex-wrap: wrap; padding: 10px; gap: 10px; top: 0; left: 0; right: 0; border-radius: 0 0 20px 20px; }
      .teacher-info { width: 100%; text-align: center; order: -1; margin-bottom: 5px; }
      .control-buttons { width: 100%; justify-content: space-around; gap: 5px; margin-left: 0; }
      .modern-btn { padding: 8px 12px; font-size: 0.85rem; flex: 1; justify-content: center; }
    }

    /* Tabs & Filters */
    #categoryTabs { justify-content: center; border: none; margin-bottom: 20px; margin-top: 20px; gap: 15px; }
    .glass-tab { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 30px !important; padding: 10px 25px; font-size: 1.2rem; font-weight: 700; color: var(--dark-color); transition: all 0.3s ease; backdrop-filter: blur(5px); }
    .glass-tab:hover { background: rgba(255,255,255,0.6); }
    .glass-tab.active { background: white; color: var(--primary-color); box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3); transform: scale(1.05); }
    #filterContainer { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 25px; padding: 0 10px; }
    .filter-btn { background: rgba(255, 255, 255, 0.3); border: 1px solid rgba(255, 255, 255, 0.5); backdrop-filter: blur(4px); color: var(--dark-color); border-radius: 20px; padding: 6px 16px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .filter-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4); }

    /* Student Cards */
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding: 10px 20px; max-width: 1400px; margin: 0 auto; }
    #groupSection { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)) !important; }
    .student-card-wrapper { width: 100%; min-width: 0; }
    .student-card { position: relative; display: flex; flex-direction: column; align-items: center; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer; }
    .student-card:hover { transform: translateY(-8px) scale(1.02); }
    .image-container { width: 100%; aspect-ratio: 1 / 1; border-radius: 24px; overflow: hidden; position: relative; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 4px solid rgba(255, 255, 255, 0.8); margin-bottom: 10px; transition: all 0.3s; }
    .image-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
    .student-card:hover img { transform: scale(1.1); }
    .student-square { width: 100%; height: 100%; }

    .frame-bronze { border: 6px solid #CD7F32 !important; box-shadow: 0 0 10px #CD7F32; }
    .frame-silver { border: 6px solid #C0C0C0 !important; box-shadow: 0 0 15px #C0C0C0; }
    .frame-gold { border: 6px solid #FFD700 !important; box-shadow: 0 0 20px #FFD700; }
    .effect-king { animation: kingGlow 2s infinite alternate; position: relative; }
    .effect-king::after { content: 'ğŸ‘‘'; position: absolute; top: -15px; left: -15px; font-size: 2.5rem; text-shadow: 0 2px 5px rgba(0,0,0,0.3); animation: floatCrown 2s ease-in-out infinite; z-index: 30; }
    @keyframes kingGlow { from { box-shadow: 0 0 10px #FFD700, 0 0 20px #FF8C00; border-color: #FFD700; } to { box-shadow: 0 0 30px #FFD700, 0 0 50px #FF8C00; border-color: #FFFACD; } }
    @keyframes floatCrown { 0%, 100% { transform: translateY(0) rotate(-15deg); } 50% { transform: translateY(-5px) rotate(-15deg); } }

    .king-pill { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #8a6d3b; font-weight: 900; font-size: 0.95rem; padding: 5px 15px; border-radius: 20px; margin-bottom: 5px; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4); border: 2px solid #fff; display: inline-block; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
    .king-pill::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0) 100%); transform: rotate(30deg); animation: shine 3s infinite; }
    @keyframes shine { 0% { left: -100%; opacity: 0; } 20% { left: 100%; opacity: 1; } 100% { left: 100%; opacity: 0; } }

    .stats-row { display: flex; justify-content: center; gap: 15px; width: 100%; margin-bottom: 8px; z-index: 10; }
    .score-pill, .cumulative-pill { display: flex; align-items: center; gap: 5px; padding: 4px 12px; border-radius: 16px; font-weight: 800; font-size: 1.3rem; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.9); color: var(--dark-color); }
    .score-pill { color: #E63946; } .cumulative-pill { color: #1D3557; }
    .info-container { display: flex; flex-direction: column; align-items: center; width: 100%; gap: 6px; }
    .info-pill { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(4px); padding: 4px 16px; border-radius: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); white-space: normal; word-break: break-word; line-height: 1.3; border: 1px solid rgba(255,255,255,0.5); }
    .student-name-pill { font-size: 1.4rem; font-weight: 800; color: #2D3E50; background: rgba(255,255,255,0.9); }
    .group-name-pill { font-size: 1rem; color: #555; }
    .title-pill { font-size: 0.95rem; font-weight: 700; color: #d35400; border: 1px solid #FFD700; background: #fffbe6; }

    .medal-wrapper { position: absolute; top: -8px; right: 10px; width: 50px; height: 60px; z-index: 20; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3)); cursor: pointer; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .medal-wrapper:hover { transform: scale(1.1) rotate(5deg); }
    .ranking-modal-body { text-align: center; padding: 1.5rem; }
    .ranking-visuals { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 1.5rem; }
    .ranking-medal-icon { font-size: 4rem; line-height: 1; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .ranking-student-img { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.15); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.1s both; }
    .ranking-student-placeholder { width: 100px; height: 100px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 2rem; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    .ranking-text { font-size: 1.6rem; font-weight: 800; margin-bottom: 0.5rem; color: var(--dark-color); }
    .ranking-subtext { font-size: 1.1rem; color: #666; margin-bottom: 1rem; }
    .ranking-score { display: inline-block; padding: 6px 20px; background: var(--secondary-color); color: white; border-radius: 25px; font-weight: bold; font-size: 1.3rem; box-shadow: 0 4px 10px rgba(78, 205, 196, 0.4); }

    /* Group Buttons */
    .group-button { border: none; border-radius: 24px; min-height: 200px; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; padding: 1.5rem; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.15); border: 4px solid rgba(255,255,255,0.4); overflow: visible; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.3s; }
    .group-button:active { transform: scale(0.96); }
    .group-name { font-size: 2.2rem; margin-bottom: 15px; font-weight: 800; }
    .group-students { background: rgba(0,0,0,0.25); padding: 10px 15px; border-radius: 15px; font-size: 1rem; line-height: 1.5; white-space: normal; word-wrap: break-word; width: 100%; }

    /* Gift & Title */
    .gift-row { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); border-radius: 24px; padding: 15px; margin-bottom: 30px; display: flex; flex-direction: row; align-items: center; box-shadow: 0 8px 32px rgba(0,0,0,0.05); }
    .gift-category-label { flex: 0 0 120px; height: 120px; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; margin-right: 20px; border: 5px solid rgba(255,255,255,0.8); box-shadow: 0 10px 20px rgba(0,0,0,0.15); color: #333; font-weight: 800; font-size: 1.1rem; }
    .gift-list-container { flex: 1; display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px; -webkit-overflow-scrolling: touch; }
    .gift-card { flex: 0 0 150px; background: rgba(255,255,255,0.8); border-radius: 18px; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; transition: transform 0.2s; }
    .gift-card:active { transform: scale(0.95); }
    .gift-point-pill { background: var(--primary-color); color: white; padding: 4px 12px; border-radius: 20px; font-size: 1rem; font-weight: 700; margin-top: auto; }
    .sold-out-wrapper { position: relative; width: 100%; height: 100px; margin-bottom: 8px; }
    .gift-img { width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; }
    .sold-out-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); display: flex; justify-content: center; align-items: center; border-radius: 10px; pointer-events: none; }
    .sold-out-stamp { color: #FF4444; border: 3px solid #FF4444; background: rgba(255,255,255,0.9); padding: 5px 8px; font-weight: 900; font-size: 1.2rem; transform: rotate(-15deg); border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); white-space: nowrap; }
    
    .title-card { background: rgba(255, 255, 255, 0.85); border-radius: 20px; padding: 20px; text-align: center; border: 4px solid rgba(255,255,255,0.6); box-shadow: 0 8px 20px rgba(0,0,0,0.08); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 160px; transition: transform 0.3s; }
    .title-card:hover { transform: translateY(-5px); }
    .title-score-badge { background: var(--primary-color); color: white; padding: 5px 15px; border-radius: 15px; font-weight: 800; margin-bottom: 12px; font-size: 1rem; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .title-name-large { font-size: 1.6rem; font-weight: 800; color: var(--dark-color); margin-top: 5px; }
    .title-holders-section { width: 100%; margin-top: 12px; padding-top: 10px; border-top: 2px dashed rgba(0,0,0,0.05); text-align: left; }
    .title-holders-label { font-size: 0.8rem; color: #666; font-weight: 700; margin-bottom: 5px; display: block; text-align: center; }
    .title-holders-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; }
    .title-holder-badge { background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 10px; padding: 2px 8px; font-size: 0.85rem; color: var(--dark-color); font-weight: 500; }
    .title-footer-text { text-align: center; margin: 40px auto; padding: 25px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border-radius: 20px; max-width: 800px; font-size: 1.2rem; color: #2D3E50; font-weight: 700; line-height: 1.8; border: 2px solid rgba(255,255,255,0.8); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }

    /* Logs */
    #logContainer { max-width: 1000px; margin: 20px auto; padding: 25px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 25px; box-shadow: 0 15px 50px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,1); }
    .filter-wrapper { margin-bottom: 20px; display: flex; justify-content: flex-end; gap: 10px; }
    .log-table { width: 100%; border-collapse: separate; border-spacing: 0; color: #333; }
    .log-table th { padding: 15px; text-align: left; font-weight: 800; font-size: 1.05rem; background: #e9ecef; color: #212529; border-bottom: 2px solid #dee2e6; }
    .log-table th:first-child { border-radius: 15px 0 0 0; }
    .log-table th:last-child { border-radius: 0 15px 0 0; }
    .log-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 1rem; font-weight: 500; }
    .log-table tr:hover { background: #f8f9fa; }
    .log-time { font-size: 0.9rem; color: #666; font-weight: 600; }
    .log-score { font-weight: 900; font-size: 1.1rem; color: #dc3545; }
    .log-score.positive { color: #198754; }

    /* Lucky Draw */
    .lucky-stage { max-width: 600px; margin: 0 auto; padding: 40px; text-align: center; border-radius: 30px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; }
    .lucky-card { width: 280px; height: 320px; background: white; border-radius: 25px; padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: transform 0.1s; cursor: pointer; }
    .lucky-img-box { width: 180px; height: 180px; border-radius: 50%; overflow: hidden; background: #f0f0f0; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; border: 5px solid var(--secondary-color); }
    .lucky-img-box img { width: 100%; height: 100%; object-fit: cover; }
    .lucky-name { font-size: 2rem; font-weight: 800; color: var(--dark-color); min-height: 3rem; display: flex; align-items: center; }
    .lucky-group-btn { padding: 10px 20px; border-radius: 20px; border: 2px solid white; background: rgba(255,255,255,0.3); font-weight: 700; color: var(--dark-color); transition: all 0.2s; }
    .lucky-group-btn.active { background: var(--secondary-color); color: white; transform: scale(1.05); box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4); border-color: var(--secondary-color); }
    .lucky-jumping { animation: popScale 0.15s infinite alternate; }
    @keyframes popScale { from { transform: scale(0.98); } to { transform: scale(1.02); } }
    .exclusion-panel { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); border-radius: 30px; padding: 20px; border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; max-height: 600px; }
    .exclusion-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; overflow-y: auto; padding: 5px; flex: 1; }
    .exclusion-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.2s; position: relative; padding: 5px; border-radius: 10px; }
    .exclusion-item:hover { background: rgba(255,255,255,0.5); transform: translateY(-2px); }
    .exclusion-item img, .exclusion-item .placeholder { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 5px; border: 2px solid white; transition: all 0.3s; }
    .exclusion-item .placeholder { background: #eee; display: flex; align-items: center; justify-content: center; color: #aaa; }
    .exclusion-item span { font-size: 0.85rem; font-weight: 700; color: var(--dark-color); text-align: center; line-height: 1.2; word-break: break-all; }
    .exclusion-item.excluded { opacity: 0.5; }
    .exclusion-item.excluded img, .exclusion-item.excluded .placeholder { filter: grayscale(100%); border-color: #999; }
    .exclusion-item.excluded::after { content: "âœ–"; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-size: 2rem; color: #FF4444; font-weight: bold; text-shadow: 0 0 5px white; pointer-events: none; }

    /* Bible & Timer & Others */
    .bible-card-main { background: linear-gradient(135deg, #fff 0%, #f3f4f6 100%); border-radius: 25px; padding: 40px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 4px solid white; position: relative; overflow: hidden; transition: transform 0.3s; }
    .bible-card-main:hover { transform: translateY(-5px); }
    .bible-card-main::before { content: 'â'; position: absolute; top: -20px; left: 20px; font-size: 8rem; color: rgba(0,0,0,0.05); font-family: serif; }
    .bible-text-large { font-size: 2rem; font-weight: 800; color: var(--dark-color); line-height: 1.6; margin-bottom: 20px; font-family: 'Noto Serif TC', serif; }
    .bible-ref-large { font-size: 1.2rem; color: #666; font-weight: 600; display: inline-block; border-top: 2px solid var(--primary-color); padding-top: 10px; }
    .bible-date-badge { font-size: 0.85rem; color: #888; margin-bottom: 15px; display: block; }
    .bible-card-sm { background: rgba(255,255,255,0.8); border-radius: 15px; padding: 15px; border: 1px solid rgba(0,0,0,0.05); height: 100%; display: flex; flex-direction: column; }
    .bible-text-sm { font-size: 1.1rem; font-weight: 700; color: #333; margin-bottom: 10px; flex-grow: 1; }
    .bible-ref-sm { font-size: 0.9rem; color: #666; text-align: right; font-style: italic; }

    /* Marquee */
    .marquee-container { max-width: 800px; margin: 10px auto 15px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 30px; padding: 8px 15px; display: flex; align-items: center; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; z-index: 90; }
    .marquee-icon { color: #ff6b6b; font-size: 1.2rem; margin-right: 15px; animation: pulseIcon 2s infinite; }
    @keyframes pulseIcon { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    .marquee-wrapper { flex: 1; overflow: hidden; white-space: nowrap; position: relative; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
    .marquee-content { display: inline-block; padding-left: 100%; animation: scrollLeft 25s linear infinite; }
    .marquee-wrapper:hover .marquee-content { animation-play-state: paused; }
    .marquee-item { display: inline-block; margin-right: 30px; font-size: 0.95rem; font-weight: 500; color: #333; }
    .marquee-score-pos { color: #198754; font-weight: 800; }
    .marquee-score-neg { color: #dc3545; font-weight: 800; }
    .marquee-time { color: #666; font-size: 0.85rem; margin-right: 5px; }
    @keyframes scrollLeft { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

    /* Timer */
    .timer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 11000; display: flex; justify-content: center; align-items: center; }
    .timer-box { background: rgba(255, 255, 255, 0.95); border-radius: 30px; padding: 30px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid white; position: relative; transition: background 0.3s; }
    .timer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; color: var(--dark-color); }
    .timer-display { font-size: 5rem; font-weight: 800; font-family: 'Baloo 2', monospace; color: var(--dark-color); line-height: 1; margin: 10px 0 20px 0; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
    .timer-presets { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
    .timer-controls { display: flex; gap: 15px; justify-content: center; }
    .time-up-flash .timer-box { animation: flashAlert 0.5s infinite alternate; }
    @keyframes flashAlert { from { background: rgba(255, 255, 255, 0.95); box-shadow: 0 0 20px red; } to { background: #FF6B6B; box-shadow: 0 0 50px red; } }
    .timer-input-group { display: flex; justify-content: center; align-items: center; gap: 10px; }
    .input-wrapper { position: relative; display: flex; align-items: center; }
    .timer-input { width: 70px; height: 50px; border: 2px solid #ddd; border-radius: 12px; text-align: center; font-size: 1.5rem; font-weight: bold; color: var(--dark-color); background: #f9f9f9; padding-right: 25px; transition: all 0.3s; }
    .timer-input:focus { border-color: var(--secondary-color); background: white; outline: none; box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2); }
    .timer-input::-webkit-outer-spin-button, .timer-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .input-wrapper .unit { position: absolute; right: 10px; color: #999; font-size: 0.9rem; font-weight: bold; pointer-events: none; }

    /* Modals & Others */
    .modal-content { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.8); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    .modal-header { border-bottom: 1px solid rgba(0,0,0,0.05); }
    .modal-footer { border-top: none; }
    .login-overlay { background: rgba(20, 20, 40, 0.6); backdrop-filter: blur(8px); position: fixed; inset: 0; z-index: 9999; display: none; justify-content: center; align-items: center; }
    .login-overlay-content { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.6); border-radius: 30px; padding: 2.5rem; width: 90%; max-width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
    .login-overlay-content input { background: rgba(255,255,255,0.6); border: 2px solid transparent; padding: 15px; border-radius: 15px; font-size: 1.1rem; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
    .login-overlay-content input:focus { background: white; border-color: var(--primary-color); box-shadow: 0 5px 15px rgba(255, 107, 107, 0.2); }
    .login-btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
    .login-btn-group button { width: 100%; padding: 14px; border-radius: 15px; font-size: 1.2rem; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(15px); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .loading-content { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 30px; border-radius: 30px; text-align: center; color: white; }
    .image-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 10001; display: none; justify-content: center; align-items: center; cursor: pointer; }
    .image-modal img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    .image-modal.show { display: flex; }
    .sending-message { color: #FF2E63; font-weight: bold; margin-right: 10px; display: none; }
    
    /* Batch Selector */
    #groupBatchSelector { background: rgba(0, 0, 0, 0.03); border-radius: 15px; padding: 10px; margin-bottom: 15px; border: 1px dashed rgba(0,0,0,0.1); }
    .batch-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .batch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; max-height: 180px; overflow-y: auto; }
    .batch-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; transition: all 0.2s; }
    .batch-item:hover { transform: translateY(-3px); }
    .batch-item img, .batch-item .placeholder { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.15); margin-bottom: 5px; transition: all 0.3s; }
    .batch-item .placeholder { background: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999; }
    .batch-item-name { font-size: 0.75rem; color: #555; text-align: center; line-height: 1.1; font-weight: 600; }
    .batch-item.excluded { opacity: 0.6; }
    .batch-item.excluded img, .batch-item.excluded .placeholder { filter: grayscale(100%); border-color: #ccc; }
    .batch-item.excluded::after { content: "âœ–"; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: #FF4444; font-size: 2rem; font-weight: 900; text-shadow: 0 0 3px white; pointer-events: none; }
    
    /* Personal History */
    #historyContainer { background: rgba(255,255,255,0.95); border-radius: 15px; border: 1px solid rgba(0,0,0,0.1); max-width: 95%; margin: 10px auto; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

    @media (max-width: 575px) {
      .gift-row { flex-direction: column; align-items: stretch; padding: 15px; }
      .gift-category-label { width: 100%; height: auto; border-radius: 15px; flex-direction: row; justify-content: space-between; padding: 10px 20px; margin: 0 0 15px 0; }
      .gift-list-container { padding-bottom: 15px; }
      .title-footer-text { margin: 20px 10px; font-size: 1rem; padding: 20px; }
      #logContainer { padding: 15px; }
      .log-table th, .log-table td { font-size: 0.85rem; padding: 10px; }
      .log-time { font-size: 0.75rem; }
    }
  </style>
</head>
<body>

<!-- Loading å‹•ç•« -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <h3><i class="fas fa-spinner fa-spin me-2"></i>è³‡æ–™è¼‰å…¥ä¸­...</h3>
    <div class="progress" style="height: 10px; margin-top: 15px;">
      <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
    </div>
  </div>
</div>

<!-- åœ–ç‰‡æ”¾å¤§é®ç½© -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
  <img id="expandedImage" src="" alt="Expanded Gift">
</div>

<!-- æ§åˆ¶é¢æ¿ (é ‚éƒ¨) -->
<div class="control-panel">
  <div class="teacher-info" id="teacherName">
    <i class="fas fa-chalkboard-teacher me-2"></i><span id="displayTeacherName"></span>
  </div>
  
  <div class="control-buttons">
    <button class="modern-btn" onclick="switchCategory('luckydraw')" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); color: #555;">
      <i class="fas fa-dice"></i> <span class="d-none d-lg-inline">æŠ½ç±¤</span>
    </button>
    <button class="modern-btn" onclick="switchCategory('dice')" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: white;">
      <i class="fas fa-dice-d20"></i> <span class="d-none d-lg-inline">éª°å­</span>
    </button>
    <button class="modern-btn" onclick="switchCategory('bible')" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: #444;">
      <i class="fas fa-book-open"></i> <span class="d-none d-lg-inline">é‡‘å¥</span>
    </button>
    <button class="modern-btn btn-timer" onclick="toggleTimerPanel()" style="background: linear-gradient(135deg, #A8E6CF 0%, #3498db 100%); color: white;">
      <i class="fas fa-stopwatch"></i> <span class="d-none d-sm-inline">è¨ˆæ™‚</span>
    </button>
    <button class="modern-btn btn-sort" id="sortScoresButton" onclick="toggleSort()">
      <i class="fas fa-sort-amount-down"></i> <span class="d-none d-sm-inline">æ’åº</span>
    </button>
    <button class="modern-btn btn-update" id="updateScoresButton" onclick="updateScores()">
      <i class="fas fa-sync-alt"></i> <span class="d-none d-sm-inline">æ›´æ–°</span>
    </button>
    <button class="modern-btn btn-login" id="loginButton" onclick="showLoginOverlay()">
      <i class="fas fa-sign-in-alt"></i> ç™»å…¥
    </button>
    <button class="modern-btn btn-logout" id="logoutButton" onclick="logoutTeacher()">
      <i class="fas fa-sign-out-alt"></i> ç™»å‡º
    </button>
  </div>
</div>

<!-- å³æ™‚åŠ åˆ†è·‘é¦¬ç‡ˆ -->
<div id="marqueeContainer" class="marquee-container" style="display:none;">
  <div class="marquee-icon"><i class="fas fa-bullhorn"></i></div>
  <div class="marquee-wrapper">
    <div id="marqueeContent" class="marquee-content">
      <span>è¼‰å…¥æœ€æ–°è¨˜éŒ„ä¸­...</span>
    </div>
  </div>
</div>

<!-- ç™»å…¥è¦–çª— -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-overlay-content">
    <h4 class="mb-4 text-center fw-bold" style="color:var(--dark-color)">æ•™å¸«ç™»å…¥</h4>
    <div class="mb-3">
      <input type="text" id="loginAccount" class="form-control" placeholder="å¸³è™Ÿ">
    </div>
    <div class="mb-3">
      <input type="password" id="loginPassword" class="form-control" placeholder="å¯†ç¢¼">
    </div>
    <div class="login-btn-group">
      <button class="modern-btn btn-login w-100" onclick="loginTeacher()">ç™»å…¥ç³»çµ±</button>
      <button class="modern-btn btn-logout w-100" style="display:block" onclick="hideLoginOverlay()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- åˆ†é å°èˆª -->
<ul class="nav nav-tabs" id="categoryTabs">
  <li class="nav-item">
    <button class="nav-link glass-tab active" data-type="student" onclick="switchCategory('student')">
      <i class="fas fa-user-graduate me-2"></i>å­¸ç”Ÿ
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" data-type="group" onclick="switchCategory('group')">
      <i class="fas fa-users me-2"></i>å°çµ„
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" data-type="gift" onclick="switchCategory('gift')">
      <i class="fas fa-gift me-2"></i>ç¦®ç‰©
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" data-type="title" onclick="switchCategory('title')">
      <i class="fas fa-crown me-2"></i>ç¨±è™Ÿ
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" data-type="log" onclick="switchCategory('log')">
      ğŸ“œ å¾—åˆ†è¨˜éŒ„è¡¨
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link glass-tab" onclick="openELearning()" style="color: #0d6efd;">
      <i class="fas fa-laptop-code me-2"></i>é›»å­æº«ç¿’ç«™
    </button>
  </li>
</ul>

<!-- ç¯©é¸æŒ‰éˆ• -->
<div id="filterContainer"></div>

<!-- é é¢å…§å®¹å®¹å™¨ -->
<div id="studentContainer"><div class="grid-container" id="studentSection"></div></div>
<div id="groupContainer" style="display: none;"><div class="grid-container" id="groupSection"></div></div>
<div id="giftContainer" class="gift-container" style="display: none;"><div id="giftSection"></div></div>
<div id="titleContainer" style="display: none;">
  <div class="grid-container" id="titleSection"></div>
  <div class="title-footer-text"><i class="fas fa-info-circle me-2"></i>ç•¶ä½ ç´¯ç©åˆ°ä¸åŒçš„åˆ†æ•¸ï¼Œä½ çš„ç¨±è™Ÿä¹Ÿæœƒæœ‰æ‰€æ”¹è®Šã€‚è©¦åŠªåŠ›ç´¯ç©æ›´å¤šçš„ç©åˆ†ï¼Œç²å¾—æ›´é…·ã€æ›´èˆ‡çœ¾ä¸åŒçš„ç¨±è™Ÿå§ï¼</div>
</div>
<div id="logContainer" style="display: none;">
  <div class="filter-wrapper" style="gap: 10px;">
    <select class="form-select" id="logGroupSelect" style="max-width: 150px; border-radius: 15px;" onchange="onLogGroupChange()"><option value="all">å…¨éƒ¨çµ„åˆ¥</option></select>
    <select class="form-select" id="logFilterSelect" style="max-width: 200px; border-radius: 15px;" onchange="filterLogs()"><option value="all">å…¨éƒ¨å­¸ç”Ÿ</option></select>
  </div>
  <div class="table-responsive">
    <table class="log-table">
      <thead><tr><th>æ™‚é–“</th><th>å­¸ç”Ÿ</th><th>è€å¸«</th><th>é …ç›®</th><th>å¾—åˆ†</th></tr></thead>
      <tbody id="logTableBody"></tbody>
    </table>
  </div>
</div>
<div id="luckyDrawContainer" style="display: none; max-width: 1200px; margin: 0 auto;">
  <div id="luckyGroupSelector" class="d-flex flex-wrap justify-content-center gap-2 mb-4"></div>
  <div class="row g-4">
    <div class="col-lg-7 col-md-12">
      <div class="lucky-stage glass-panel h-100">
        <div class="lucky-card-wrapper">
          <div id="luckyCard" class="lucky-card">
            <div class="lucky-img-box"><i class="fas fa-question" id="luckyDefaultIcon" style="font-size: 80px; color: #ddd;"></i><img id="luckyImage" src="" style="display: none;"></div>
            <div class="lucky-name" id="luckyName">èª°æ˜¯å¹¸é‹å…’ï¼Ÿ</div>
          </div>
        </div>
        <div class="lucky-controls mt-4 d-flex gap-3 justify-content-center flex-wrap">
          <button class="modern-btn" id="startLuckyBtn" onclick="toggleLuckyDrawManual()" style="padding: 12px 30px; background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white;"><i class="fas fa-play me-2"></i> æ‰‹å‹•é–‹å§‹</button>
          <button class="modern-btn" id="autoLuckyBtn" onclick="startAutoLuckyDraw()" style="padding: 12px 30px; background: linear-gradient(135deg, #4ECDC4, #556270); color: white;"><i class="fas fa-robot me-2"></i> é›»è…¦æç </button>
        </div>
        <div class="mt-2 text-muted small"><i class="fas fa-info-circle me-1"></i> é›»è…¦æç å°‡éš¨æ©Ÿè½‰å‹• 2~5 ç§’</div>
      </div>
    </div>
    <div class="col-lg-5 col-md-12">
      <div class="exclusion-panel glass-panel h-100">
        <h5 class="mb-3 fw-bold text-center"><i class="fas fa-user-slash me-2"></i>é»æ“Šé ­åƒä»¥æ’é™¤å­¸ç”Ÿ</h5>
        <div class="d-flex justify-content-between mb-2 px-2">
          <span class="small text-muted">ç°è‰² = æœ¬æ¬¡ä¸åƒèˆ‡æŠ½ç±¤</span>
          <button class="btn btn-sm btn-outline-secondary" onclick="resetExclusion()" style="border-radius:15px; font-size: 0.8rem;">å…¨éƒ¨é‡ç½®</button>
        </div>
        <div id="exclusionList" class="exclusion-grid"></div>
      </div>
    </div>
  </div>
</div>
<div id="diceContainer" style="display: none; max-width: 800px; margin: 0 auto;">
  <div class="glass-panel p-4 text-center" style="background: rgba(255, 255, 255, 0.5); border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
    <h3 class="fw-bold mb-4" style="color: var(--dark-color);"><i class="fas fa-dice me-2"></i>å‘½é‹çš„éª°å­</h3>
    <div class="d-flex justify-content-center gap-4 mb-5">
      <div class="dice-selector active" id="selDice6" onclick="selectDiceType(6)"><i class="fas fa-dice-six fa-3x mb-2"></i><div>6 é¢éª°</div></div>
      <div class="dice-selector" id="selDice20" onclick="selectDiceType(20)"><i class="fas fa-dice-d20 fa-3x mb-2"></i><div>20 é¢éª°</div></div>
    </div>
    <div class="dice-stage mb-5"><div id="diceDisplay" class="dice-box dice-d6"><span id="diceResult">?</span></div></div>
    <button class="modern-btn" onclick="rollDice()" style="font-size: 1.5rem; padding: 15px 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">è©¦è©¦æ‰‹æ°£ï¼</button>
  </div>
</div>
<div id="bibleContainer" style="display: none; max-width: 1000px; margin: 0 auto;">
  <div id="currentVerseSection" class="mb-5">
    <div class="text-center mb-3"><span class="badge rounded-pill bg-warning text-dark fs-6 px-3 py-2 shadow-sm"><i class="fas fa-star me-1"></i> æœ¬é€±é‡‘å¥</span></div>
    <div id="currentVerseCard"></div>
  </div>
  <div class="glass-panel p-4" style="background: rgba(255, 255, 255, 0.6); border-radius: 20px;">
    <h4 class="fw-bold mb-3 text-secondary"><i class="fas fa-history me-2"></i>é‡‘å¥åº«</h4>
    <div id="bibleList" class="row g-3"></div>
  </div>
</div>

<!-- Modals -->
<div class="modal fade" id="scoreModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="scoreModalLabel">âœ¨ åŠ æ‰£åˆ†æ“ä½œ</h5>
        <button type="button" class="btn-close" onclick="closeScoreModal()"></button>
      </div>
      <div class="modal-body">
        <p id="modalTargetInfo" class="fs-5 fw-bold text-center" style="color:var(--dark-color)"></p>
        <div id="groupBatchSelector" style="display:none;">
           <div class="batch-header"><span class="small text-muted fw-bold"><i class="fas fa-users-cog me-1"></i>é»æ“Šé ­åƒæ’é™¤å­¸ç”Ÿ</span><button class="btn btn-sm btn-outline-primary py-0" onclick="resetBatchSelection()" style="border-radius:10px; font-size:0.8rem;">å…¨é¸</button></div>
           <div id="batchGrid" class="batch-grid"></div>
        </div>
        <div id="xpContainer" class="mb-4 mx-auto p-3" style="display:none; background: linear-gradient(to right, #ffffb8, #fff); border-radius: 15px; border: 2px solid #FFE66D; max-width: 90%;">
           <div id="xpText" class="text-center fw-bold mb-2" style="color: #856404; font-size: 0.95rem; line-height: 1.4;"></div>
           <div class="progress" style="height: 12px; border-radius: 10px; background-color: rgba(0,0,0,0.05);"><div id="xpBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; background-color: #FFC107;"></div></div>
           <div id="monthlyScoreText" class="text-center mt-2 pt-2" style="border-top: 1px dashed rgba(0,0,0,0.1); font-size: 0.9rem; color: #555; font-weight: 700;"></div>
        </div>
        <div id="historyContainer" class="mt-3 mx-auto p-3" style="display:none; background: rgba(255,255,255,0.6); border-radius: 15px; border: 1px solid rgba(0,0,0,0.1); max-width: 90%;">
           <h6 class="fw-bold text-center mb-2" style="color: #555;"><i class="fas fa-history me-2"></i>æœ€è¿‘å¾—åˆ†ç´€éŒ„</h6>
           <div class="table-responsive mb-2">
             <table class="table table-sm table-borderless" style="font-size: 0.9rem; margin-bottom: 0;">
               <thead style="border-bottom: 1px solid #ddd;"><tr style="color: #777;"><th style="width: 25%">æ—¥æœŸ</th><th style="width: 55%">é …ç›®</th><th style="width: 20%; text-align: right;">å¾—åˆ†</th></tr></thead>
               <tbody id="historyTableBody"></tbody>
             </table>
           </div>
           <div id="historyPagination" class="d-flex justify-content-between align-items-center mt-2" style="font-size: 0.85rem;">
             <button class="btn btn-sm btn-light border" onclick="changeHistoryPage(-1)" id="prevHistoryBtn" style="border-radius: 10px;">â—€ ä¸Šä¸€é </button><span id="historyPageLabel" style="color: #666; font-weight: 600;">1 / 1</span><button class="btn btn-sm btn-light border" onclick="changeHistoryPage(1)" id="nextHistoryBtn" style="border-radius: 10px;">ä¸‹ä¸€é  â–¶</button>
           </div>
        </div>
        <div id="teacherControls" style="display: none;">
            <div class="d-flex justify-content-center gap-3 mb-4 score-category">
              <button class="modern-btn" style="background:#4ECDC4; color:white; flex:1;" id="addPointsBtn" onclick="setScoreCategory('åŠ åˆ†')"><i class="fas fa-plus-circle fa-2x d-block mb-1"></i> åŠ åˆ†</button>
              <button class="modern-btn" style="background:white; color:#aaa; border:1px solid #ddd; flex:1;" id="deductPointsBtn" onclick="setScoreCategory('æ‰£åˆ†')"><i class="fas fa-minus-circle fa-2x d-block mb-1"></i> æ‰£åˆ†</button>
            </div>
            <div class="mb-3"><label class="form-label fw-bold">é¸æ“‡é …ç›®ï¼š</label><select class="form-select form-select-lg" id="itemSelect" onchange="updateScoreOptions()" style="border-radius:15px;"></select></div>
            <div class="mb-4"><label class="form-label fw-bold">é¸æ“‡åˆ†æ•¸ï¼š</label><select class="form-select form-select-lg" id="scoreSelect" onchange="toggleCustomInput()" style="border-radius:15px;"></select><input type="number" id="customScoreInput" class="form-control form-control-lg mt-2" placeholder="è«‹è¼¸å…¥æ•¸å€¼ (ä¾‹å¦‚: 50)" style="display:none; border-radius:15px; border: 2px solid var(--accent-color);" min="1"></div>
            <div class="text-center"><span class="sending-message" id="sendingMessage"><i class="fas fa-paper-plane me-1"></i> è³‡æ–™å‚³é€ä¸­...</span></div>
        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="modern-btn" style="background:#eee; color:#555; padding:10px 30px;" onclick="closeScoreModal()">å–æ¶ˆ</button>
        <button type="button" class="modern-btn btn-login" style="padding:10px 40px;" id="confirmScoreBtn" onclick="sendScoreRecord()">ç¢ºå®šé€å‡º</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="rankingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0"><h5 class="modal-title fw-bold">ğŸ† å°çµ„æ’åæ¦®è­½</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body ranking-modal-body" id="rankingModalBody"></div>
      <div class="modal-footer border-0 justify-content-center"><button type="button" class="modern-btn" style="background:#4ECDC4; color:white; padding:10px 40px;" data-bs-dismiss="modal">å¤ªæ£’äº†ï¼</button></div>
    </div>
  </div>
</div>
<div id="timerPanel" class="timer-overlay" style="display: none;">
  <div class="timer-box">
    <div class="timer-header"><h4 class="m-0"><i class="fas fa-clock me-2"></i>èª²å ‚è¨ˆæ™‚å™¨</h4><button class="btn-close" onclick="toggleTimerPanel()"></button></div>
    <div class="timer-display" id="timerDisplay">00:00</div>
    <div class="timer-input-group mb-3">
      <div class="input-wrapper"><input type="number" id="timerInputMin" class="timer-input" placeholder="0" min="0" max="99"><span class="unit">åˆ†</span></div>
      <div class="input-wrapper"><input type="number" id="timerInputSec" class="timer-input" placeholder="0" min="0" max="59"><span class="unit">ç§’</span></div>
      <button class="modern-btn btn-sm" onclick="applyCustomTime()" style="background:var(--dark-color); color:white; margin-left:10px;">è¨­å®š</button>
    </div>
    <div class="timer-presets text-muted small mb-2">å¿«é€Ÿå¢åŠ ï¼š<button class="btn btn-outline-secondary btn-sm rounded-pill py-0" onclick="addTime(1)">+1åˆ†</button> <button class="btn btn-outline-secondary btn-sm rounded-pill py-0" onclick="addTime(5)">+5åˆ†</button> <button class="btn btn-outline-secondary btn-sm rounded-pill py-0" onclick="addTime(10)">+10åˆ†</button></div>
    <div class="timer-controls mt-4">
      <button class="modern-btn" id="btnStartTimer" onclick="startTimer()" style="background:#4ECDC4; color:white; width:100px;"><i class="fas fa-play"></i> é–‹å§‹</button>
      <button class="modern-btn" id="btnPauseTimer" onclick="stopTimer()" style="background:#FFD93D; color:#555; width:100px; display:none;"><i class="fas fa-pause"></i> æš«åœ</button>
      <button class="modern-btn" onclick="resetTimer()" style="background:#FF6B6B; color:white;"><i class="fas fa-undo"></i> é‡ç½®</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ==========================================
  // CONFIGURATION: GAS API URL
  // ==========================================
  const API_URL = https://script.google.com/macros/s/AKfycbyWkt5bTcX8BokqviAXoMgFaWTyU2PkqqeHy-rhGRiJlsWkkn6-wLGfdylDFWLfh-nC/exec;

  // API Call Helper
  async function callApi(action, params = {}) {
    const payload = { action: action, ...params };
    const response = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error);
    return data;
  }

  // ==========================================
  // Global Variables
  // ==========================================
  let allStudents=[], originalStudents=[], teacherList=[], allItems=[], allGroups=[], allGifts=[], titleConfig={enabled:false,rules:[]}, allLogs=[], monthlyKings=[], allVerses=[], appSettings={};
  let currentTeacher=null, isSorted=false, modalTargetType="", modalTargetName="", currentScoreCategory="åŠ åˆ†", currentFilter="all", batchExcludedSet=new Set();
  const studentScoreMap={};
  let progressInterval;
  const loadingOverlay=document.getElementById('loadingOverlay'), progressBar=document.getElementById('progressBar');
  
  // Lucky Draw vars
  let luckyIntervalId=null, currentGroupStudents=[], activeCandidates=[], excludedNames=new Set(), currentLuckyStudent=null;
  
  // History vars
  const HISTORY_PER_PAGE=5; let currentHistoryPage=1, currentModalStudent=null;

  // Dice vars
  let currentDiceMax=6, isRolling=false;

  // Timer vars
  let timerInterval=null, totalSeconds=0, isTimerRunning=false;
  const alarmSound=new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  alarmSound.loop=true;

  // ==========================================
  // Initialization
  // ==========================================
  window.onload = function() {
    startLoadingSimulation();
    callApi('getInitialData')
      .then(data => {
        finishLoading();
        if (!data) throw new Error("ç„¡è³‡æ–™");
        allStudents = data.students || [];
        originalStudents = [...allStudents];
        teacherList = data.teachers || [];
        allItems = data.items || [];
        allGroups = data.groups || [];
        allGifts = data.gifts || [];
        titleConfig = data.titles || { enabled: false, rules: [] };
        allLogs = data.logs || [];
        monthlyKings = data.monthlyKings || [];
        allVerses = data.bibleVerses || [];
        appSettings = data.settings || {};

        generateFilterButtons();
        renderPage();
        if(document.getElementById('filterContainer')) document.getElementById('filterContainer').style.display='flex';
      })
      .catch(error => {
        clearInterval(progressInterval);
        updateProgressBar(100);
        alert("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š" + error.message);
        finishLoading();
      });
  };

  function renderPage() {
    renderStudents();
    renderGroups();
    renderGifts();
    renderTitles();
    initLogFilter();
    renderMarquee();
    if (currentTeacher) {
        document.getElementById('displayTeacherName').textContent = currentTeacher['å§“å'];
        document.querySelector('.teacher-info').style.display = 'block';
        document.getElementById('loginButton').style.display = 'none';
        document.getElementById('logoutButton').style.display = 'inline-flex';
    } else {
        document.querySelector('.teacher-info').style.display = 'none';
        document.getElementById('loginButton').style.display = 'inline-flex';
        document.getElementById('logoutButton').style.display = 'none';
    }
  }

  // ==========================================
  // Core Logic
  // ==========================================
  function generateFilterButtons() {
    const filterContainer = document.getElementById('filterContainer');
    if (!filterContainer) return;
    filterContainer.innerHTML = ''; 
    const allBtn = document.createElement('button'); allBtn.className = 'filter-btn active'; allBtn.textContent = 'å…¨éƒ¨';
    allBtn.onclick = () => filterStudents('all', allBtn); filterContainer.appendChild(allBtn);
    allGroups.forEach(groupName => {
      const btn = document.createElement('button'); btn.className = 'filter-btn'; btn.textContent = groupName;
      btn.onclick = () => filterStudents(groupName, btn); filterContainer.appendChild(btn);
    });
  }

  function filterStudents(groupName, btnElement) {
    currentFilter = groupName;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');
    renderStudents();
  }

  function renderStudents() {
    const container = document.getElementById('studentSection'); if (!container) return;
    container.innerHTML = '';
    const groupRankMap = getGroupRankings(allStudents);
    let studentsToRender = isSorted ? allStudents : originalStudents;
    if (currentFilter !== 'all') studentsToRender = studentsToRender.filter(s => String(s["åˆ†çµ„"]).trim() === currentFilter);
    
    studentsToRender.forEach(stu => {
      const score = Number(stu["ç¸½å¾—åˆ†"]) || 0;
      const cumulativeScore = Number(stu["ç´¯ç©åˆ†æ•¸"]) || 0;
      const groupName = String(stu["åˆ†çµ„"]).trim() || "æœªåˆ†çµ„";
      const imgUrl = (stu["åœ–ç‰‡ç¶²å€"] && String(stu["åœ–ç‰‡ç¶²å€"]).trim() !== '') ? stu["åœ–ç‰‡ç¶²å€"] : '';
      
      let titleHtml = '', kingHtml = '', frameClass = '', effectClass = '';
      if (titleConfig.enabled && titleConfig.rules.length > 0) {
        const sortedRules = [...titleConfig.rules].sort((a, b) => Number(b.score) - Number(a.score));
        for (const rule of sortedRules) { if (cumulativeScore >= Number(rule.score)) { titleHtml = `<div class="info-pill title-pill">(${rule.score}) ${rule.title}</div>`; break; } }
      }
      if (monthlyKings.includes(stu["å§“å"])) { kingHtml = `<div class="king-pill">ğŸ‘‘ æœ¬æœˆå¾—åˆ†ç‹ï¼</div>`; effectClass = 'effect-king'; }
      if (cumulativeScore >= 80) frameClass = 'frame-gold'; else if (cumulativeScore >= 35) frameClass = 'frame-silver'; else if (cumulativeScore >= 20) frameClass = 'frame-bronze';

      const myRank = groupRankMap[stu["å§“å"]];
      let medalHtml = '';
      if (myRank === 1) medalHtml = getMedalHtml('gold', stu["å§“å"], groupName, cumulativeScore, imgUrl);
      else if (myRank === 2) medalHtml = getMedalHtml('silver', stu["å§“å"], groupName, cumulativeScore, imgUrl);
      else if (myRank === 3) medalHtml = getMedalHtml('bronze', stu["å§“å"], groupName, cumulativeScore, imgUrl);

      const wrapper = document.createElement('div'); wrapper.className = "student-card-wrapper";
      const card = document.createElement('div'); card.className = "student-card";
      let imageContent = imgUrl ? `<div class="image-container ${frameClass} ${effectClass}"><img src="${imgUrl}" alt="${stu["å§“å"]}" onerror="handleImageError(this)">${medalHtml}</div>` : `<div class="image-container ${frameClass} ${effectClass}"><div class="student-square" style="background:${generateRandomPastelColor()};"></div>${medalHtml}</div>`;
      card.innerHTML = `${imageContent}<div class="stats-row"><div class="score-pill"><span>ğŸŒŸ</span> ${score}</div><div class="cumulative-pill"><span>ğŸ’¡</span> ${cumulativeScore}</div></div><div class="info-container">${kingHtml}${titleHtml}<div class="info-pill student-name-pill">${stu["å§“å"]}</div><div class="info-pill group-name-pill">${groupName}</div></div>`;
      card.onclick = () => openScoreModal("å­¸ç”Ÿ", stu["å§“å"]);
      wrapper.appendChild(card); container.appendChild(wrapper);
      studentScoreMap[stu["å§“å"]] = card.querySelector(".score-pill"); 
    });
  }

  function renderGroups() {
    const container = document.getElementById('groupSection'); if (!container) return;
    container.innerHTML = '';
    const gradients = ['linear-gradient(135deg, #FF6B6B, #FFA07A)', 'linear-gradient(135deg, #4ECDC4, #A0D8D4)', 'linear-gradient(135deg, #4F80E1, #80A7F5)', 'linear-gradient(135deg, #8A2BE2, #B98BEF)', 'linear-gradient(135deg, #FFD700, #FFEE79)', 'linear-gradient(135deg, #3CB371, #8FD4AA)'];
    allGroups.forEach((groupName, index) => {
      const studentsInGroup = allStudents.filter(s => String(s["åˆ†çµ„"]).trim() === groupName);
      const studentsStr = studentsInGroup.map(s => s["å§“å"]).join('ã€');
      const groupBtn = document.createElement('div'); groupBtn.className = "group-button";
      groupBtn.style.background = gradients[index % gradients.length];
      groupBtn.innerHTML = `<div class="group-name">${groupName}</div><div class="group-students">${studentsStr}</div>`;
      groupBtn.onclick = () => openScoreModal("å°çµ„", groupName);
      const wrapper = document.createElement('div'); wrapper.className="student-card-wrapper";
      wrapper.appendChild(groupBtn); container.appendChild(wrapper);
    });
  }

  function renderGifts() {
    const container = document.getElementById('giftSection'); if (!container) return;
    container.innerHTML = '';
    const tiers = [{ name: "ç§€æ‰è³", range: "5åˆ†æˆ–ä»¥ä¸‹", min: -9999, max: 5, color: "var(--tier1-color)" }, { name: "æ¢èŠ±è³", range: "6è‡³25åˆ†", min: 6, max: 25, color: "var(--tier2-color)" }, { name: "æ¦œçœ¼è³", range: "26è‡³40åˆ†", min: 26, max: 40, color: "var(--tier3-color)" }, { name: "ç‹€å…ƒè³", range: "41è‡³85åˆ†", min: 41, max: 85, color: "var(--tier4-color)" }, { name: "é‡‘æ¦œä¹‹é¦–", range: "86åˆ†ä»¥ä¸Š", min: 86, max: 99999, color: "var(--tier5-color)" }];
    tiers.forEach(tier => {
      let tierGifts = allGifts.filter(g => { const s = Number(g["æ‰€éœ€åˆ†æ•¸"])||0; return s >= tier.min && s <= tier.max; });
      tierGifts.sort((a,b) => { const qtyA=(a["æ•¸é‡"]===""||a["æ•¸é‡"]===undefined)?999:Number(a["æ•¸é‡"]); const qtyB=(b["æ•¸é‡"]===""||b["æ•¸é‡"]===undefined)?999:Number(b["æ•¸é‡"]); if(qtyA===0 && qtyB!==0) return 1; if(qtyA!==0 && qtyB===0) return -1; return (Number(a["æ‰€éœ€åˆ†æ•¸"])||0)-(Number(b["æ‰€éœ€åˆ†æ•¸"])||0); });
      const rowDiv = document.createElement('div'); rowDiv.className = 'gift-row';
      rowDiv.innerHTML = `<div class="gift-category-label" style="background:${tier.color}"><span class="gift-label-title">${tier.name}</span><span class="gift-label-desc">${tier.range}</span></div>`;
      const listDiv = document.createElement('div'); listDiv.className = 'gift-list-container';
      if(tierGifts.length===0) listDiv.innerHTML='<div style="padding:10px; opacity:0.5;">æš«ç„¡ç¦®ç‰©</div>';
      else {
        tierGifts.forEach(gift => {
          const qty=(gift["æ•¸é‡"]===""||gift["æ•¸é‡"]===undefined)?999:Number(gift["æ•¸é‡"]); const isSoldOut=(qty===0); const imgUrl=gift["åœ–ç‰‡é€£çµ"]||'';
          const imgTag = imgUrl ? `<img src="${imgUrl}" class="gift-img" onclick="openImageModal('${imgUrl}')">` : `<div class="gift-img d-flex align-items-center justify-content-center" style="background:#eee;border-radius:10px;"><i class="fas fa-gift fa-3x text-secondary"></i></div>`;
          const overlay = isSoldOut ? `<div class="sold-out-overlay"><div class="sold-out-stamp">ç¼ºè²¨ï¼</div></div>` : '';
          const card = document.createElement('div'); card.className = 'gift-card';
          card.innerHTML = `<div class="sold-out-wrapper">${imgTag}${overlay}</div><div class="gift-name">${gift["ç¦®ç‰©åç¨±"]}</div><div class="gift-point-pill">${gift["æ‰€éœ€åˆ†æ•¸"]} åˆ†</div>`;
          listDiv.appendChild(card);
        });
      }
      rowDiv.appendChild(listDiv); container.appendChild(rowDiv);
    });
  }

  function renderTitles() {
    const container = document.getElementById('titleSection'); if (!container) return;
    container.innerHTML = '';
    const rules = (titleConfig && titleConfig.rules) ? titleConfig.rules : [];
    if (rules.length === 0) { container.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:#555;">æš«ç„¡ç¨±è™Ÿè³‡æ–™</div>'; return; }
    
    // Calculate holders
    const holdersMap = {};
    const sortedRulesForCalc = [...rules].sort((a, b) => Number(b.score) - Number(a.score));
    allStudents.forEach(stu => {
        const cScore = Number(stu["ç´¯ç©åˆ†æ•¸"]) || 0;
        const matchedRule = sortedRulesForCalc.find(r => cScore >= Number(r.score));
        if (matchedRule) { if (!holdersMap[matchedRule.title]) holdersMap[matchedRule.title] = []; holdersMap[matchedRule.title].push(stu["å§“å"]); }
    });

    rules.sort((a, b) => (Number(a.score) || 0) - (Number(b.score) || 0));
    rules.forEach(rule => {
      const wrapper = document.createElement('div'); wrapper.className = "student-card-wrapper"; 
      const card = document.createElement('div'); card.className = "title-card";
      let holdersHtml = ''; const holders = holdersMap[rule.title] || [];
      if (holders.length > 0) { holders.sort((a, b) => a.localeCompare(b)); const listItems = holders.map(name => `<span class="title-holder-badge">${name}</span>`).join(''); holdersHtml = `<div class="title-holders-section"><span class="title-holders-label">ç›®å‰æ“æœ‰æ­¤ç¨±è™Ÿï¼š</span><div class="title-holders-list">${listItems}</div></div>`; }
      card.innerHTML = `<div class="title-score-badge">ğŸ† ç©åˆ† ${rule.score}</div><div class="title-name-large">${rule.title}</div>${holdersHtml}`;
      wrapper.appendChild(card); container.appendChild(wrapper);
    });
  }

  function initLogFilter() {
    const groupSel = document.getElementById('logGroupSelect'), studentSel = document.getElementById('logFilterSelect');
    if(!groupSel || !studentSel) return;
    groupSel.innerHTML = '<option value="all">å…¨éƒ¨çµ„åˆ¥</option>';
    [...allGroups].sort().forEach(g => { const opt = document.createElement('option'); opt.value = g; opt.textContent = g; groupSel.appendChild(opt); });
    updateLogStudentOptions('all');
  }

  function onLogGroupChange() { updateLogStudentOptions(document.getElementById('logGroupSelect').value); filterLogs(); }
  
  function updateLogStudentOptions(groupName) {
    const studentSel = document.getElementById('logFilterSelect'); studentSel.innerHTML = '<option value="all">å…¨éƒ¨å­¸ç”Ÿ</option>';
    let targetStudents = allStudents;
    if (groupName !== 'all') targetStudents = allStudents.filter(s => String(s["åˆ†çµ„"]).trim() === groupName);
    targetStudents.sort((a,b) => a['å§“å'].localeCompare(b['å§“å']));
    targetStudents.forEach(s => { const opt = document.createElement('option'); opt.value = s['å§“å']; opt.textContent = s['å§“å']; studentSel.appendChild(opt); });
  }

  function filterLogs() { renderLogs(document.getElementById('logGroupSelect').value, document.getElementById('logFilterSelect').value); }

  function renderLogs(groupFilter = 'all', studentFilter = 'all') {
    const tbody = document.getElementById('logTableBody'); tbody.innerHTML = '';
    let logsToShow = allLogs.filter(log => {
      const studentInfo = allStudents.find(s => s["å§“å"] === log.student);
      const studentGroup = studentInfo ? String(studentInfo["åˆ†çµ„"]).trim() : "æœªåˆ†çµ„";
      return ((groupFilter === 'all') || (studentGroup === groupFilter)) && ((studentFilter === 'all') || (log.student === studentFilter));
    });
    if (logsToShow.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#888; padding: 20px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</td></tr>'; return; }
    logsToShow.forEach(log => {
      const tr = document.createElement('tr'); const date = new Date(log.time);
      const timeStr = date.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      const teacherObj = teacherList.find(t => t['å¸³è™Ÿ'] === log.teacherAcc);
      const teacherName = teacherObj ? teacherObj['å§“å'] : log.teacherAcc;
      const scoreNum = Number(log.score);
      const scoreClass = scoreNum > 0 ? 'log-score positive' : 'log-score';
      tr.innerHTML = `<td class="log-time">${timeStr}</td><td style="font-weight:bold;">${log.student}</td><td>${teacherName}</td><td>${log.item}</td><td class="${scoreClass}">${scoreNum>0?'+':''}${scoreNum}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderMarquee() {
    const container = document.getElementById('marqueeContainer'), content = document.getElementById('marqueeContent');
    if (!container || !content) return;
    if (!allLogs || allLogs.length === 0) { container.style.display = 'none'; return; }
    container.style.display = 'flex';
    let html = '';
    allLogs.slice(0, 15).forEach(log => {
      const date = new Date(log.time); const timeStr = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
      const scoreNum = Number(log.score); const scoreClass = scoreNum >= 0 ? 'marquee-score-pos' : 'marquee-score-neg';
      html += `<span class="marquee-item"><span class="marquee-time">[${timeStr}]</span><strong>${log.student}</strong><span class="${scoreClass}">${scoreNum>=0?'+':''}${scoreNum}</span><span style="font-size:0.85rem; color:#555;">(${log.item})</span></span>`;
    });
    content.innerHTML = html;
  }

  // ==========================================
  // Action Handlers
  // ==========================================
  function updateScores() {
    const btn = document.getElementById('updateScoresButton'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    callApi('getLatestScores')
      .then(res => {
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> <span class="d-none d-sm-inline">æ›´æ–°</span>';
        res.forEach(r => { const s = allStudents.find(x => x["å§“å"]===r.name); if(s) { s["ç¸½å¾—åˆ†"]=r.score; s["ç´¯ç©åˆ†æ•¸"]=r.cumulative; } });
        if(isSorted) allStudents.sort((a,b)=>(b["ç´¯ç©åˆ†æ•¸"]||0)-(a["ç´¯ç©åˆ†æ•¸"]||0));
        renderStudents();
      })
      .catch(e => { alert("æ›´æ–°å¤±æ•—: " + e); btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> <span class="d-none d-sm-inline">æ›´æ–°</span>'; });
  }

  function sendScoreRecord() {
    const item = document.getElementById('itemSelect').value;
    let score = document.getElementById('scoreSelect').value;
    if (score === 'custom') { score = document.getElementById('customScoreInput').value; if (!score || score <= 0) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ­£æ•´æ•¸ï¼"); return; } }
    
    let finalTargetType = modalTargetType, finalTargetName = modalTargetName;
    if (modalTargetType === "å°çµ„") {
        const groupStudents = allStudents.filter(s => String(s["åˆ†çµ„"]).trim() === modalTargetName);
        if (batchExcludedSet.size === groupStudents.length) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½å­¸ç”Ÿï¼"); return; }
        if (batchExcludedSet.size > 0) {
            finalTargetType = "è‡ªè¨‚åå–®";
            finalTargetName = groupStudents.map(s => s["å§“å"]).filter(name => !batchExcludedSet.has(name)).join(",");
        }
    }
    const btn = document.getElementById('confirmScoreBtn'); btn.disabled = true; btn.innerHTML = "å‚³é€ä¸­...";
    
    callApi('addScoreRecord', { teacherAccount: currentTeacher["å¸³è™Ÿ"], targetType: finalTargetType, targetName: finalTargetName, item: item, score: score })
      .then(res => {
          closeScoreModal(); btn.disabled = false; btn.innerHTML = "ç¢ºå®šé€å‡º";
          res.forEach(r => { const s = allStudents.find(x => x["å§“å"]===r.name); if(s) { s["ç¸½å¾—åˆ†"] = r.score; s["ç´¯ç©åˆ†æ•¸"] = r.cumulative; } });
          if(isSorted) allStudents.sort((a,b)=>(b["ç´¯ç©åˆ†æ•¸"]||0)-(a["ç´¯ç©åˆ†æ•¸"]||0));
          renderStudents();
      })
      .catch(e => { alert("éŒ¯èª¤ï¼š" + e); btn.disabled = false; btn.innerHTML = "ç¢ºå®šé€å‡º"; });
  }

  function loginTeacher() {
    const acc = document.getElementById('loginAccount').value.trim();
    const pwd = document.getElementById('loginPassword').value.trim();
    const t = teacherList.find(x => String(x['å¸³è™Ÿ'])===acc && String(x['å¯†ç¢¼'])===pwd);
    if(t) { currentTeacher = t; hideLoginOverlay(); renderPage(); } else alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
  }

  function logoutTeacher() { currentTeacher = null; isSorted = false; document.getElementById('sortScoresButton').innerHTML = '<i class="fas fa-sort-amount-down"></i> <span class="d-none d-sm-inline">æ’åº</span>'; renderPage(); }
  
  function switchCategory(type) {
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    const activeTab = document.querySelector(`[data-type="${type}"]`); if (activeTab) activeTab.classList.add('active');
    ['student','group','gift','title','log','luckydraw','dice','bible'].forEach(k => { const el = document.getElementById(k+'Container'); if(el) el.style.display = (k===type)?'block':'none'; });
    if(type==='student') { document.getElementById('filterContainer').style.display='flex'; renderStudents(); } else document.getElementById('filterContainer').style.display='none';
    if(type==='group') renderGroups();
    if(type==='gift') renderGifts();
    if(type==='title') renderTitles();
    if(type==='log') filterLogs();
    if(type==='luckydraw') initLuckyDraw();
    if(type==='bible') renderBibleVerses();
    const sortBtn = document.getElementById('sortScoresButton'); if(sortBtn) sortBtn.style.visibility = (type==='student'||type==='group')?'visible':'hidden';
  }

  // ==========================================
  // Helper Logic (Modal, Utils)
  // ==========================================
  function openScoreModal(type, name) {
    modalTargetType = type; modalTargetName = name;
    const infoEl = document.getElementById('modalTargetInfo'); if(infoEl) infoEl.textContent = `${type}ï¼š${name}`;
    const batchContainer = document.getElementById('groupBatchSelector'); if (batchContainer) batchContainer.style.display = 'none';
    const xpContainer = document.getElementById('xpContainer'); if(xpContainer) xpContainer.style.display = 'none';
    document.getElementById('historyContainer').style.display = 'none';

    if (type === "å­¸ç”Ÿ") {
      updateLevelProgress(name);
      currentModalStudent = name; currentHistoryPage = 1; renderStudentHistory(name);
    } else if (type === "å°çµ„") {
      if (batchContainer) { batchContainer.style.display = 'block'; renderBatchSelector(name); }
    }
    
    const teacherArea = document.getElementById('teacherControls'), confirmBtn = document.getElementById('confirmScoreBtn'), modalTitle = document.getElementById('scoreModalLabel');
    if (teacherArea && confirmBtn) {
        if (currentTeacher) {
            teacherArea.style.display = 'block'; confirmBtn.style.display = 'inline-block';
            if(modalTitle) modalTitle.textContent = "âœ¨ åŠ æ‰£åˆ†æ“ä½œ"; setScoreCategory("åŠ åˆ†");
        } else {
            teacherArea.style.display = 'none'; confirmBtn.style.display = 'none';
            if(modalTitle) modalTitle.textContent = "ğŸ“ å­¸ç”Ÿç­‰ç´šè³‡è¨Š";
        }
    }
    new bootstrap.Modal(document.getElementById('scoreModal')).show();
  }
  
  function updateLevelProgress(studentName) {
    const xpContainer = document.getElementById('xpContainer'), xpText = document.getElementById('xpText'), xpBar = document.getElementById('xpBar'), monthlyText = document.getElementById('monthlyScoreText');
    const student = allStudents.find(s => s["å§“å"] === studentName);
    if (!student || !titleConfig.enabled || !titleConfig.rules || titleConfig.rules.length === 0) return;
    const currentScore = Number(student["ç´¯ç©åˆ†æ•¸"]) || 0; const monthScore = Number(student["æœ¬æœˆå¾—åˆ†"]) || 0;
    const rules = [...titleConfig.rules].sort((a, b) => Number(a.score) - Number(b.score));
    let currentTitleObj = { score: 0, title: "ç„¡ç¨±è™Ÿ" }, nextTitleObj = null;
    for (let i = 0; i < rules.length; i++) { if (currentScore >= Number(rules[i].score)) currentTitleObj = rules[i]; else { nextTitleObj = rules[i]; break; } }
    
    xpContainer.style.display = 'block';
    if (nextTitleObj) {
      const range = Number(nextTitleObj.score) - Number(currentTitleObj.score);
      const percent = Math.min(100, Math.max(0, ((currentScore - Number(currentTitleObj.score)) / range) * 100));
      xpBar.style.width = `${percent}%`; xpText.innerHTML = `ä½ ç¾åœ¨æ˜¯ <strong>(${currentScore}) ${currentTitleObj.title}</strong><br><span style="color:#d35400">ğŸ” è·é›¢ä¸‹ä¸€ç´šé‚„å·® <strong>${Number(nextTitleObj.score) - currentScore}</strong> åˆ†</span>`;
    } else {
      xpBar.style.width = '100%'; xpText.innerHTML = `ä½ ç¾åœ¨æ˜¯ <strong>(${currentScore}) ${currentTitleObj.title}</strong><br>ğŸ‰ å·²é”åˆ°æœ€é«˜æ¦®è­½ï¼`;
    }
    if (monthlyText) {
       let htmlContent = `ğŸ“… æœ¬æœˆå·²ç´¯ç©ï¼š<span style="color:#d63384; font-size:1.1rem; font-weight:800;">${monthScore}</span> åˆ†`;
       const myGroup = String(student["åˆ†çµ„"]).trim();
       let maxInGroup = -1, leaderName = "";
       allStudents.forEach(s => { if (String(s["åˆ†çµ„"]).trim() === myGroup) { const sMonthScore = Number(s["æœ¬æœˆå¾—åˆ†"])||0; if (sMonthScore > maxInGroup) { maxInGroup = sMonthScore; leaderName = s["å§“å"]; } } });
       if (maxInGroup <= 0) htmlContent += `<div style="margin-top:8px; font-size:0.9rem; color:#777;">ğŸš€ æœ¬æœˆæˆ°é¬¥å‰›é–‹å§‹ï¼Œå¿«å»å®Œæˆä¸­æ–‡ä»»å‹™ï¼Œç²å–åˆ†æ•¸ï¼</div>`;
       else if (monthScore >= maxInGroup) htmlContent += `<div style="margin-top:8px; font-size:0.95rem; color:#d35400; font-weight:bold; background:rgba(255, 215, 0, 0.15); padding:5px; border-radius:8px;">ğŸ‘‘ å“‡ï¼ä½ æ˜¯æœ¬çµ„ç›®å‰çš„å¾—åˆ†ç‹ï¼<br>è«‹ç¹¼çºŒä¿æŒé ˜å…ˆï¼</div>`;
       else htmlContent += `<div style="margin-top:8px; font-size:0.9rem; color:#2c3e50; background:#f8f9fa; padding:6px; border-radius:8px; border:1px dashed #ccc;">ğŸ‘€ ä½ å’Œæœ¬çµ„å¾—åˆ†ç‹ <strong>${leaderName}</strong> <br>è·é›¢åªå·® <span style="color:#e74c3c; font-weight:800; font-size:1.1rem;">${maxInGroup - monthScore}</span> åˆ†ï¼<br><span style="font-size:0.85rem; color:#666;">ğŸ’ª è«‹å¤šåŠ åŠªåŠ›ï¼Œè¿½ä¸Šå»ï¼</span></div>`;
       monthlyText.innerHTML = htmlContent;
    }
  }

  // --- Lucky Draw Logic ---
  function initLuckyDraw() {
    const container = document.getElementById('luckyGroupSelector'); container.innerHTML = '';
    [...allGroups].sort().forEach((group, index) => {
      const btn = document.createElement('button'); btn.className = 'modern-btn lucky-group-btn'; btn.textContent = group;
      btn.onclick = () => selectLuckyGroup(group, btn); container.appendChild(btn);
      if (index === 0) selectLuckyGroup(group, btn);
    });
  }
  function selectLuckyGroup(groupName, btnElement) {
    if(btnElement) { document.querySelectorAll('.lucky-group-btn').forEach(b => b.classList.remove('active')); btnElement.classList.add('active'); }
    currentGroupStudents = allStudents.filter(s => String(s["åˆ†çµ„"]).trim() === groupName);
    excludedNames.clear(); renderExclusionList(); updateActiveCandidates(); resetLuckyCard();
  }
  function renderExclusionList() {
    const list = document.getElementById('exclusionList'); list.innerHTML = '';
    currentGroupStudents.forEach(stu => {
        const item = document.createElement('div'); item.className = 'exclusion-item'; item.onclick = () => toggleExclusion(stu["å§“å"], item);
        let imgHtml = stu["åœ–ç‰‡ç¶²å€"] ? `<img src="${stu["åœ–ç‰‡ç¶²å€"]}">` : `<div class="placeholder"><i class="fas fa-user"></i></div>`;
        item.innerHTML = `${imgHtml}<span>${stu["å§“å"]}</span>`; list.appendChild(item);
    });
  }
  function toggleExclusion(name, domElement) {
    if (luckyIntervalId) return;
    if (excludedNames.has(name)) { excludedNames.delete(name); domElement.classList.remove('excluded'); } else { excludedNames.add(name); domElement.classList.add('excluded'); }
    updateActiveCandidates();
  }
  function resetExclusion() { if (luckyIntervalId) return; excludedNames.clear(); document.querySelectorAll('.exclusion-item').forEach(el => el.classList.remove('excluded')); updateActiveCandidates(); }
  function updateActiveCandidates() {
    activeCandidates = currentGroupStudents.filter(s => !excludedNames.has(s["å§“å"])); const disabled = activeCandidates.length === 0;
    document.getElementById('startLuckyBtn').disabled = disabled; document.getElementById('autoLuckyBtn').disabled = disabled;
    document.getElementById('luckyName').textContent = disabled ? "åå–®ç‚ºç©º" : (luckyIntervalId ? document.getElementById('luckyName').textContent : `å…± ${activeCandidates.length} äººå¾…å‘½`);
  }
  function toggleLuckyDrawManual() {
    const btn = document.getElementById('startLuckyBtn'), autoBtn = document.getElementById('autoLuckyBtn');
    if (luckyIntervalId) { stopAnimation(); btn.innerHTML = '<i class="fas fa-redo me-2"></i> æ‰‹å‹•å†æŠ½'; autoBtn.disabled = false; }
    else { if (activeCandidates.length === 0) return; startAnimation(); btn.innerHTML = '<i class="fas fa-stop me-2"></i> åœæ­¢'; autoBtn.disabled = true; }
  }
  function startAutoLuckyDraw() {
    if (activeCandidates.length === 0) return;
    const manualBtn = document.getElementById('startLuckyBtn'), autoBtn = document.getElementById('autoLuckyBtn');
    manualBtn.disabled = true; autoBtn.disabled = true; autoBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> è½‰å‹•ä¸­...';
    startAnimation(); setTimeout(() => { stopAnimation(); manualBtn.disabled = false; autoBtn.disabled = false; autoBtn.innerHTML = '<i class="fas fa-robot me-2"></i> é›»è…¦æç '; manualBtn.innerHTML = '<i class="fas fa-play me-2"></i> æ‰‹å‹•é–‹å§‹'; }, Math.floor(Math.random() * 3000) + 2000);
  }
  function startAnimation() {
    const card = document.getElementById('luckyCard'); card.classList.add('lucky-jumping'); card.onclick = null;
    document.getElementById('luckyDefaultIcon').style.display = 'none'; document.getElementById('luckyImage').style.display = 'block';
    luckyIntervalId = setInterval(() => { const student = activeCandidates[Math.floor(Math.random() * activeCandidates.length)]; currentLuckyStudent = student; updateLuckyCardDisplay(student); }, 80);
  }
  function stopAnimation() { clearInterval(luckyIntervalId); luckyIntervalId = null; document.getElementById('luckyCard').classList.remove('lucky-jumping'); if (currentLuckyStudent) document.getElementById('luckyCard').onclick = () => openScoreModal("å­¸ç”Ÿ", currentLuckyStudent["å§“å"]); }
  function updateLuckyCardDisplay(student) {
    document.getElementById('luckyName').textContent = student["å§“å"];
    if (student["åœ–ç‰‡ç¶²å€"]) { document.getElementById('luckyImage').src = student["åœ–ç‰‡ç¶²å€"]; document.getElementById('luckyImage').style.display = 'block'; document.getElementById('luckyDefaultIcon').style.display = 'none'; }
    else { document.getElementById('luckyImage').style.display = 'none'; document.getElementById('luckyDefaultIcon').style.display = 'block'; }
  }
  function resetLuckyCard() { document.getElementById('luckyImage').style.display = 'none'; document.getElementById('luckyDefaultIcon').style.display = 'block'; document.getElementById('luckyCard').onclick = null; document.getElementById('luckyCard').classList.remove('lucky-jumping'); document.getElementById('startLuckyBtn').innerHTML = '<i class="fas fa-play me-2"></i> æ‰‹å‹•é–‹å§‹'; currentLuckyStudent = null; }

  // --- Dice Logic ---
  function selectDiceType(sides) {
    if (isRolling) return; currentDiceMax = sides;
    document.getElementById('selDice6').classList.toggle('active', sides === 6); document.getElementById('selDice20').classList.toggle('active', sides === 20);
    const diceDisplay = document.getElementById('diceDisplay'), resultSpan = document.getElementById('diceResult');
    resultSpan.innerText = "?";
    if (sides === 6) { diceDisplay.classList.remove('dice-d20'); diceDisplay.classList.add('dice-d6'); } else { diceDisplay.classList.remove('dice-d6'); diceDisplay.classList.add('dice-d20'); }
  }
  function rollDice() {
    if (isRolling) return; isRolling = true;
    const diceDisplay = document.getElementById('diceDisplay'), resultSpan = document.getElementById('diceResult');
    diceDisplay.classList.add('dice-shaking'); resultSpan.classList.remove('dice-pop');
    let tempInterval = setInterval(() => { resultSpan.innerText = Math.floor(Math.random() * currentDiceMax) + 1; }, 80);
    setTimeout(() => { clearInterval(tempInterval); diceDisplay.classList.remove('dice-shaking'); resultSpan.innerText = Math.floor(Math.random() * currentDiceMax) + 1; resultSpan.classList.add('dice-pop'); isRolling = false; }, 1500);
  }

  // --- Bible Logic ---
  function renderBibleVerses() {
    const currentContainer = document.getElementById('currentVerseCard'), listContainer = document.getElementById('bibleList');
    if (!currentContainer || !listContainer || !allVerses) return;
    currentContainer.innerHTML = ''; listContainer.innerHTML = '';
    const now = new Date(); now.setHours(0,0,0,0);
    let currentVerse = null, otherVerses = [];
    const sortedVerses = [...allVerses].sort((a, b) => new Date(b["é–‹å§‹æ—¥æœŸ"]) - new Date(a["é–‹å§‹æ—¥æœŸ"]));
    for (const v of sortedVerses) {
      const sDateObj = new Date(v["é–‹å§‹æ—¥æœŸ"]), eDateObj = new Date(v["çµæŸæ—¥æœŸ"]);
      if (isNaN(sDateObj) || isNaN(eDateObj)) continue;
      sDateObj.setHours(0,0,0,0); eDateObj.setHours(23,59,59,999);
      if (!currentVerse && ((now >= sDateObj && now <= eDateObj) || String(v["é«˜äº®æç¤ºæœ¬é€±é‡‘å¥"] || "").trim() !== "")) currentVerse = v;
      else otherVerses.push(v);
    }
    if (currentVerse) {
      currentContainer.innerHTML = `<div class="bible-card-main"><span class="bible-date-badge"><i class="far fa-calendar-alt me-1"></i> ${currentVerse["é–‹å§‹æ—¥æœŸ"]} ~ ${currentVerse["çµæŸæ—¥æœŸ"]}</span><div class="bible-text-large">${currentVerse["ç¶“æ–‡"]}</div><div class="bible-ref-large">${currentVerse["å‡ºè™•"]}</div></div>`;
    } else currentContainer.innerHTML = `<div class="bible-card-main" style="opacity:0.7;"><div class="bible-text-large" style="font-size:1.5rem; color:#999;">æœ¬é€±æš«ç„¡æŒ‡å®šé‡‘å¥</div><div class="bible-ref-large">è«‹è¤‡ç¿’ä¸‹æ–¹é‡‘å¥åº«</div></div>`;
    if (otherVerses.length === 0) listContainer.innerHTML = '<div class="text-center text-muted w-100 py-4">æš«ç„¡æ­·å²é‡‘å¥</div>';
    else {
      otherVerses.forEach(v => {
          const col = document.createElement('div'); col.className = 'col-md-6 col-lg-4';
          col.innerHTML = `<div class="bible-card-sm"><div class="small text-muted mb-2">${v["é–‹å§‹æ—¥æœŸ"]} ~ ${v["çµæŸæ—¥æœŸ"]}</div><div class="bible-text-sm">${v["ç¶“æ–‡"]}</div><div class="bible-ref-sm">â€” ${v["å‡ºè™•"]}</div></div>`;
          listContainer.appendChild(col);
      });
    }
  }

  // --- Timer Logic ---
  function toggleTimerPanel() { const panel = document.getElementById('timerPanel'); if (window.getComputedStyle(panel).display === 'none') { panel.style.display = 'flex'; stopAlarm(); setTimeout(() => document.getElementById('timerInputMin').focus(), 100); } else { panel.style.display = 'none'; stopTimer(); stopAlarm(); } }
  function applyCustomTime() { let m = parseInt(document.getElementById('timerInputMin').value)||0; let s = parseInt(document.getElementById('timerInputSec').value)||0; stopTimer(); stopAlarm(); totalSeconds = (m * 60) + s; updateTimerDisplay(); }
  function addTime(minutes) { stopAlarm(); if (isTimerRunning) stopTimer(); totalSeconds += minutes * 60; updateTimerDisplay(); document.getElementById('timerInputMin').value = Math.floor(totalSeconds / 60); document.getElementById('timerInputSec').value = totalSeconds % 60; }
  function resetTimer() { stopTimer(); stopAlarm(); totalSeconds = 0; updateTimerDisplay(); document.getElementById('timerInputMin').value = ''; document.getElementById('timerInputSec').value = ''; }
  function startTimer() { if (totalSeconds === 0) applyCustomTime(); if (totalSeconds <= 0) { alert("è«‹å…ˆè¼¸å…¥æ™‚é–“ï¼"); return; } if (isTimerRunning) return; alarmSound.play().then(() => alarmSound.pause()).catch(() => {}); isTimerRunning = true; document.getElementById('btnStartTimer').style.display = 'none'; document.getElementById('btnPauseTimer').style.display = 'inline-block'; timerInterval = setInterval(() => { if (totalSeconds > 0) { totalSeconds--; updateTimerDisplay(); } else timeIsUp(); }, 1000); }
  function stopTimer() { isTimerRunning = false; clearInterval(timerInterval); document.getElementById('btnStartTimer').style.display = 'inline-block'; document.getElementById('btnPauseTimer').style.display = 'none'; }
  function updateTimerDisplay() { const m = Math.floor(totalSeconds / 60); const s = totalSeconds % 60; document.getElementById('timerDisplay').textContent = `${m < 10 ? "0" + m : m}:${s < 10 ? "0" + s : s}`; }
  function timeIsUp() { stopTimer(); document.getElementById('timerPanel').classList.add('time-up-flash'); alarmSound.currentTime = 0; alarmSound.play().catch(e => console.log("Audio play failed", e)); }
  function stopAlarm() { alarmSound.pause(); alarmSound.currentTime = 0; document.getElementById('timerPanel').classList.remove('time-up-flash'); }

  // --- Utils ---
  function getGroupRankings(students) { const groups={}; students.forEach(s => { const g=String(s["åˆ†çµ„"]).trim()||"æœªåˆ†çµ„"; if(!groups[g]) groups[g]=[]; groups[g].push(s); }); const rankMap={}; for(const g in groups) { groups[g].sort((a,b)=>(Number(b["ç´¯ç©åˆ†æ•¸"])||0)-(Number(a["ç´¯ç©åˆ†æ•¸"])||0)); let cur=1, last=-1; groups[g].forEach((s,i)=>{ const sc=Number(s["ç´¯ç©åˆ†æ•¸"])||0; if(i===0) last=sc; else if(sc<last){ cur++; last=sc; } rankMap[s["å§“å"]]=cur; }); } return rankMap; }
  function getMedalHtml(type, name, group, score, imgUrl) { 
    let color = type === 'gold' ? '#FFD700' : (type === 'silver' ? '#C0C0C0' : '#CD7F32');
    const safeImg = imgUrl ? imgUrl : '';
    return `<div class="medal-wrapper" onclick="showRankingModal('${name}', '${group}', '${type==='gold'?'ç¬¬ä¸€':(type==='silver'?'ç¬¬äºŒ':'ç¬¬ä¸‰')}', ${score}, '${safeImg}', event)"><svg viewBox="0 0 24 30" width="100%" height="100%"><path d="M2 0h20v20l-10 10-10-10z" fill="${color}" stroke="#fff" stroke-width="1.5" /><circle cx="12" cy="10" r="6" fill="#FFF" fill-opacity="0.3" /><text x="12" y="14" font-size="10" text-anchor="middle" fill="#FFF" font-weight="bold">${type==='gold'?'1':(type==='silver'?'2':'3')}</text></svg></div>`;
  }
  function handleImageError(img) { const c=img.parentElement; img.style.display='none'; const s=document.createElement('div'); s.className='student-square'; s.style.background=generateRandomPastelColor(); c.insertBefore(s, c.firstChild); }
  function generateRandomPastelColor() { return `hsl(${Math.floor(Math.random()*360)}, 70%, 80%)`; }
  function startLoadingSimulation() { let p=0; progressInterval=setInterval(()=>{ if(p<95){ p+=Math.floor(Math.random()*5)+1; if(p>95)p=95; updateProgressBar(p); } },500); }
  function updateProgressBar(p) { if(progressBar) progressBar.style.width=p+'%'; }
  function finishLoading() { clearInterval(progressInterval); updateProgressBar(100); setTimeout(()=>{ if(loadingOverlay) { loadingOverlay.style.opacity='0'; setTimeout(()=>{loadingOverlay.style.display='none';},500); } },300); }
  function closeImageModal() { document.getElementById('imageModal').classList.remove('show'); }
  function openImageModal(url) { document.getElementById('expandedImage').src=url; document.getElementById('imageModal').classList.add('show'); }
  function closeScoreModal() { bootstrap.Modal.getInstance(document.getElementById('scoreModal')).hide(); }
  function showLoginOverlay() { document.getElementById('loginOverlay').style.display='flex'; }
  function hideLoginOverlay() { document.getElementById('loginOverlay').style.display='none'; }
  function toggleSort() { isSorted=!isSorted; document.getElementById('sortScoresButton').innerHTML=isSorted?'<i class="fas fa-undo"></i> <span class="d-none d-sm-inline">é‚„åŸ</span>':'<i class="fas fa-sort-amount-down"></i> <span class="d-none d-sm-inline">æ’åº</span>'; if(isSorted)allStudents.sort((a,b)=>(b["ç´¯ç©åˆ†æ•¸"]||0)-(a["ç´¯ç©åˆ†æ•¸"]||0)); else allStudents=[...originalStudents]; renderStudents(); }
  function showRankingModal(name, group, rank, score, img, e) { if(e){e.stopPropagation();e.preventDefault();} const b=document.getElementById('rankingModalBody'); b.innerHTML=`<div class="ranking-visuals"><div class="ranking-medal-icon">${rank==='ç¬¬ä¸€'?'ğŸ¥‡':(rank==='ç¬¬äºŒ'?'ğŸ¥ˆ':'ğŸ¥‰')}</div>${img?`<img src="${img}" class="ranking-student-img">`:`<div class="ranking-student-placeholder"><i class="fas fa-user"></i></div>`}</div><div class="ranking-text">${name}</div><div class="ranking-subtext">ç›®å‰æ˜¯ <strong>${group}</strong> æ’å${rank}ï¼</div><div class="ranking-score">ç¸½å¾—åˆ†(ç´¯ç©)ï¼š${score}</div>`; new bootstrap.Modal(document.getElementById('rankingModal')).show(); }
  function renderBatchSelector(groupName) {
      const grid = document.getElementById('batchGrid'), container = document.getElementById('groupBatchSelector');
      const headerText = container.querySelector('.batch-header span'), selectAllBtn = container.querySelector('.batch-header button');
      grid.innerHTML = ''; batchExcludedSet.clear();
      const isTeacher = (currentTeacher !== null);
      if (isTeacher) { headerText.innerHTML = '<i class="fas fa-users-cog me-1"></i>é»æ“Šé ­åƒæ’é™¤å­¸ç”Ÿ'; selectAllBtn.style.display = 'inline-block'; container.style.background = 'rgba(0, 0, 0, 0.03)'; container.style.border = '1px dashed rgba(0,0,0,0.1)'; } 
      else { headerText.innerHTML = '<i class="fas fa-users me-1"></i>å°çµ„æˆå“¡åå–®'; selectAllBtn.style.display = 'none'; container.style.background = 'transparent'; container.style.border = 'none'; container.style.padding = '0'; }
      const students = allStudents.filter(s => String(s["åˆ†çµ„"]).trim() === groupName);
      if (students.length === 0) { grid.innerHTML = '<span class="text-muted small">æ­¤å°çµ„ç„¡æˆå“¡</span>'; return; }
      students.forEach(s => {
          const div = document.createElement('div'); div.className = 'batch-item';
          if (isTeacher) { div.onclick = () => toggleBatchItem(s["å§“å"], div); div.style.cursor = 'pointer'; } else { div.style.cursor = 'default'; }
          let imgHtml = s["åœ–ç‰‡ç¶²å€"] ? `<img src="${s["åœ–ç‰‡ç¶²å€"]}">` : `<div class="placeholder"><i class="fas fa-user"></i></div>`;
          div.innerHTML = `${imgHtml}<div class="batch-item-name">${s["å§“å"]}</div>`; grid.appendChild(div);
      });
  }
  function toggleBatchItem(name, el) { if (batchExcludedSet.has(name)) { batchExcludedSet.delete(name); el.classList.remove('excluded'); } else { batchExcludedSet.add(name); el.classList.add('excluded'); } }
  function resetBatchSelection() { batchExcludedSet.clear(); document.querySelectorAll('.batch-item').forEach(el => el.classList.remove('excluded')); }
  function openELearning() { const url = appSettings["é›»å­æº«ç¿’ç«™è¶…é€£çµ"]; if (url && url.startsWith("http")) window.open(url, '_blank'); else alert("âš ï¸ å°šæœªè¨­å®šæœ‰æ•ˆçš„æº«ç¿’ç«™ç¶²å€ï¼Œè«‹è€å¸«è‡³å¾Œå°ã€Œè¨­å®šã€å·¥ä½œè¡¨ç¢ºèªã€‚"); }
  
  // Render Student History
  function renderStudentHistory(name) {
    const container=document.getElementById('historyContainer'), tbody=document.getElementById('historyTableBody');
    const pageLabel=document.getElementById('historyPageLabel'), prevBtn=document.getElementById('prevHistoryBtn'), nextBtn=document.getElementById('nextHistoryBtn');
    const myLogs=allLogs.filter(log => log.student === name);
    if (myLogs.length === 0) { container.style.display = 'none'; return; }
    container.style.display = 'block';
    const totalPages = Math.ceil(myLogs.length / HISTORY_PER_PAGE);
    if (currentHistoryPage > totalPages) currentHistoryPage = totalPages; if (currentHistoryPage < 1) currentHistoryPage = 1;
    const startIndex = (currentHistoryPage - 1) * HISTORY_PER_PAGE;
    const pagedLogs = myLogs.slice(startIndex, startIndex + HISTORY_PER_PAGE);
    tbody.innerHTML = '';
    pagedLogs.forEach(log => {
      const tr = document.createElement('tr'); const d = new Date(log.time); const score = Number(log.score);
      tr.innerHTML = `<td style="color:#666;">${d.getMonth()+1}/${d.getDate()}</td><td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;" title="${log.item}">${log.item}</td><td style="text-align: right; color:${score>0?'#198754':'#dc3545'}; font-weight:800;">${score>0?'+':''}${score}</td>`;
      tbody.appendChild(tr);
    });
    pageLabel.textContent = `${currentHistoryPage} / ${totalPages}`;
    prevBtn.disabled = (currentHistoryPage === 1); nextBtn.disabled = (currentHistoryPage === totalPages);
  }
  function changeHistoryPage(d) { currentHistoryPage += d; renderStudentHistory(currentModalStudent); }
  function setScoreCategory(c) { currentScoreCategory=c; document.getElementById('addPointsBtn').style.opacity=c==="åŠ åˆ†"?1:0.5; document.getElementById('deductPointsBtn').style.opacity=c==="æ‰£åˆ†"?1:0.5; const s=document.getElementById('itemSelect'); s.innerHTML=""; allItems.filter(it=>it["åŠ æ‰£åˆ†"]===c).forEach(it=>{const o=document.createElement('option');o.value=it["é …ç›®åç¨±"];o.textContent=it["é …ç›®åç¨±"];s.appendChild(o);}); updateScoreOptions(); }
  function updateScoreOptions() { const s=document.getElementById('scoreSelect'); s.innerHTML=""; (currentScoreCategory==="åŠ åˆ†"?[1,2,3,4,5]:[1,2,3,5,7]).forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=`${currentScoreCategory} ${v} åˆ†`;s.appendChild(o);}); const c=document.createElement('option');c.value='custom';c.textContent='âœï¸ è‡ªè¡Œè¼¸å…¥æ•¸å€¼...';s.appendChild(c); toggleCustomInput(); }
  function toggleCustomInput() { const v=document.getElementById('scoreSelect').value, i=document.getElementById('customScoreInput'); if(v==='custom'){i.style.display='block';i.value='';i.focus();}else{i.style.display='none';} }

</script>
</body>
</html>